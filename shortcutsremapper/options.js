(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N={}.hasOwnProperty,C=function(e,t){function r(){this.constructor=e}for(var n in t)N.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};n=Backbone.View.extend({onShowUiDialog:function(t,n){return t!==this.name?!1:(this.modelId=n,e(".backscreen").show())},onClickIconRemove:function(){return this.hideDialogs()},hideDialogs:function(){return e(".backscreen").hide(),this.$el.hide()}}),c={closeOtherTabs:"Close other tabs",closeTabsLeft:"Close tabs to the left",closeTabsRight:"Close tabs to the right",moveTabLeft:"Move current tab left",moveTabRight:"Move current tab right",moveTabFirst:"Move current tab to first position",moveTabLast:"Move current tab to last position",duplicateTab:"Duplicates a current tab",duplicateTabWin:"Duplicates a current tab in a new window",detachTab:"Detachs a current tab",switchNextWin:"Switches to the next window",switchPrevWin:"Switches to the previous window"},r=function(e){function t(e){t.__super__.constructor.call(this,e)}return C(t,e),t.prototype.name="command",t.prototype.el=".commands",t.prototype.events={"submit form":"onSubmitForm","click  .icon-remove":"onClickIconRemove"},t.prototype.render=function(){var e,t;t=this.$(".commandRadios"),t.empty();for(e in c)t.append(this.tmplItem({key:e,value:c[e]}));return this},t.prototype.onShowUiDialog=function(e,n,r){if(!t.__super__.onShowUiDialog.call(this,e,n))return;return this.render(),r&&this.$(".radioCommand").val([r.name]),this.$el.show(),this.el.style.pixelLeft=(window.innerWidth-this.$el.width())/2,this.el.style.pixelTop=Math.round((window.innerHeight-this.$el.height())/2)},t.prototype.onSubmitForm=function(){var e;return(e=this.$(".radioCommand:checked").val())&&this.trigger("setCommand",this.modelId,{name:e}),this.hideDialogs(),!1},t.prototype.tmplItem=_.template('<div>\n  <label>\n    <input type="radio" name="radioCommand" class="radioCommand" value="<%=key%>">\n    <%=value%>\n  </label>\n</div>'),t}(n),t=function(t){function n(e){var t;n.__super__.constructor.call(this,e),this.elBookmark$=this.$(".result"),t=document.getCSSCanvasContext("2d","triangle",8,5.5),t.fillStyle="#000000",t.translate(.5,.5),t.beginPath(),t.moveTo(0,0),t.lineTo(0,1),t.lineTo(3.5,4.5),t.lineTo(7,1),t.lineTo(7,0),t.closePath(),t.fill(),t.stroke(),this.$(".result_outer").niceScroll({cursorwidth:12,cursorborderradius:6,smoothscroll:!0,cursoropacitymin:.1,cursoropacitymax:.6})}return C(n,t),n.prototype.name="bookmark",n.prototype.el=".bookmarks",n.prototype.events={"submit form":"onSubmitForm","click  a":"onClickBookmark","click  .title":"onClickFolder","click  .expand-icon":"onClickExpandIcon","click  .expand":"onClickExpand","click  .icon-remove":"onClickIconRemove"},n.prototype.onClickFolder=function(t){var n,r;return r=(n=e(t.currentTarget).parent()).hasClass("opened"),r?n.removeClass("opened expanded"):n.addClass("opened expanded"),T(),t.stopPropagation()},n.prototype.onClickExpandIcon=function(t){var n,r;return n=(r=e(t.currentTarget).parent()).hasClass("expanded"),n?r.removeClass("expanded"):r.addClass("expanded"),T(),t.stopPropagation()},n.prototype.onClickExpand=function(){return this.$(".expand").is(":checked")?this.$(".folder").addClass("opened expanded"):this.$(".folder").removeClass("opened expanded"),T()},n.prototype.onShowUiDialog=function(e,t){var r,i,s;if(!n.__super__.onShowUiDialog.call(this,e,t))return;return this.$(".result").children().length===0&&this.onSubmitForm(),r=window.innerHeight-60,i=(window.innerWidth-600)/2,this.el.style.pixelTop=20,this.el.style.pixelLeft=i,this.$(".result_outer").height(r-30),this.$el.height(r).show(),(s=this.$("input.query")).val()&&s.focus(),this.$(".result_outer").getNiceScroll().show()},n.prototype.onSubmitForm=function(){var t,n,r=this;return this.$(".result").empty(),t=this.$("input.query").focus().val(),t&&(this.$(".expand")[0].checked=!0),n=this.$(".expand").is(":checked")?"opened expanded":"",chrome.bookmarks.getTree(function(i){var s;return i.forEach(function(e){return r.digBookmarks(e,r.elBookmark$,t,0,n)}),r.elBookmark$.append(s=e(r.tmplFolder({title:"Recent",state:n,indent:0}))),s.find(".title").prepend('<img src="images/star.png">'),chrome.bookmarks.getRecent(50,function(e){return e.forEach(function(e){return r.digBookmarks(e,s,t,1,n)})})}),!1},n.prototype.digBookmarks=function(t,n,r,i,s){var o,u=this;if(t.title){t.state=s;if(t.children)t.indent=i,n.append(o=e(this.tmplFolder(t))),n=o;else if(!r||(t.title+" "+t.url).toUpperCase().indexOf(r.toUpperCase())>-1)t.indent=i+1,n.append(e(this.tmplLink(t)))}else i--;if(t.children)return n.parent().addClass("hasFolder"),t.children.forEach(function(e){return u.digBookmarks(e,n,r,i+1,s)})},n.prototype.hideDialogs=function(){return this.$(".result_outer").getNiceScroll().hide(),n.__super__.hideDialogs.call(this)},n.prototype.onClickBookmark=function(t){var n;return n=e(t.currentTarget),this.trigger("setBookmark",this.modelId,{title:n.text(),url:n.attr("title"),bmId:n.attr("data-id")}),this.hideDialogs()},n.prototype.tmplFolder=_.template('<div class="folder <%=state%>" style="text-indent:<%=indent%>em">\n  <span class="expand-icon"></span><span class="title"><%=title%></span>\n</div>'),n.prototype.tmplLink=_.template('<div class="link" style="text-indent:<%=indent%>em;">\n  <a href="#" title="<%=url%>" data-id="<%=id%>" style="background-image:-webkit-image-set(url(\'chrome://favicon/size/16@1x/<%=url%>\') 1x);"><%=title%></a>\n</div>'),n}(n),v={},m=null,l={google:{families:["Noto+Sans::latin"]}},y={assignOrg:"None",command:"Command",bookmark:"Bookmark",simEvent:"Simurate key event",disabled:"Disabled",through:"Through"},p=function(e){var t;return t={"&":"&amp;","<":"&lt;",">":"&gt;"},e.replace(/[&<>]/g,function(e){return t[e]})},s=Backbone.View.extend({scHelpUrl:"https://support.google.com/chrome/answer/157179?hl=",el:"div.header",events:{"click button.addKeyConfig":"onClickAddKeyConfig","change select.kbdtype":"onChangeSelKbd"},initialize:function(t){var n,r,i=this;return m=v[n=this.model.get("kbdtype")].keys,r=this.$("select.kbdtype"),e.each(v,function(e,t){return r.append('<option value="'+e+'">'+t.name+"</option>")}),r.val(n),this.setScHelp(n)},onClickAddKeyConfig:function(e){return this.trigger("clickAddKeyConfig",e)},onChangeSelKbd:function(e){return this.trigger("changeSelKbd",e),this.setScHelp(this.$("select.kbdtype").val())},setScHelp:function(e){return e==="JP"?this.$(".scHelp").text("ショートカットキー一覧").attr("href",this.scHelpUrl+"ja"):this.$(".scHelp").text("Keyboard shortcuts").attr("href",this.scHelpUrl+"en")}}),i=Backbone.Model.extend({}),o=Backbone.Model.extend({idAttribute:"proxy",defaults:{mode:"assignOrg"}}),u=Backbone.Collection.extend({model:o}),f=Backbone.View.extend({kbdtype:null,optionKeys:[],events:{"click .origin,.proxy":"onClickInput","click div.mode":"onClickMode","click i.icon-pencil":"onClickEditDesc","click .selectMode div":"onChangeMode","click i.icon-remove":"onClickRemove","submit .memo":"onSubmitMemo","blur  .selectMode":"onBlurSelectMode","blur  input.memo":"onBlurInputMemo"},initialize:function(e){return this.optionKeys=_.keys(y),this.model.on({"change:bookmark":this.onChangeBookmark,"change:command":this.onChangeCommand,setFocus:this.onClickInput,remove:this.onRemove},this),this.model.collection.on({kbdEvent:this.onKbdEvent,changeKbd:this.onChangeKbd,updateOrder:this.onUpdateOrder},this)},render:function(e){var t;return this.setElement(this.template({options:y})),t=this.model.get("mode"),this.setKbdValue(this.$(".proxy"),this.model.id),this.setKbdValue(this.$(".origin"),this.model.get("origin")),this.kbdtype=e,this.onChangeMode(null,t),this},onChangeBookmark:function(){return this.onChangeMode(null,"bookmark")},onChangeCommand:function(){return this.onChangeMode(null,"command")},onRemove:function(){return this.model.off(null,null,this),this.off(null,null,null),this.remove()},onKbdEvent:function(t){var n,r;r=this.$("div:focus");if(r.length>0){if(r.hasClass("proxy")){if(this.model.id!==t&&this.model.collection.findWhere({proxy:t})){this.trigger("decodeKbdEvent",t,n={}),e("#tiptip_content").text('"'+n.result+'" is already exists.'),r.tipTip();return}}else if(~~t.substring(2)>512)return;return this.setKbdValue(r,t),this.model.set(r[0].className.match(/(proxy|origin)/)[0],t),this.setDesc(),this.trigger("resizeInput")}},onChangeKbd:function(e){return this.kbdtype=e,this.setKbdValue(this.$(".proxy"),this.model.id),this.setKbdValue(this.$(".origin"),this.model.get("origin")),this.setDesc()},onUpdateOrder:function(){return this.model.set("ordernum",this.$el.parent().children().index(this.$el))},onClickEditDesc:function(){var e,t,n;return(n=this.$("div.memo")).toggle(),e=(t=this.$("form.memo").toggle().find("input")).is(":visible"),e?t.focus().val(n.text()):this.onSubmitMemo(),event.stopPropagation()},onClickMode:function(){return this.$(".selectMode").toggle().is(":visible")?(this.$(".selectMode").focus(),this.$(".mode").addClass("selecting")):this.$(".mode").removeClass("selecting"),event.stopPropagation()},onChangeMode:function(e,t){if(e){this.$(".mode").removeClass("selecting"),t=e.currentTarget.className,this.$(".selectMode").hide();if(t==="bookmark"||t==="command"){this.trigger("showUiDialog",t,this.model.id,this.model.get(t));return}}return this.model.set("mode",t),this.$(".mode").removeClass(this.optionKeys.join(" ")).addClass(t),this.setDispMode(t),this.setDesc(),this.trigger("resizeInput")},onBlurSelectMode:function(){return this.$(".selectMode").hide(),this.$(".mode").removeClass("selecting")},onClickInput:function(t,n){return t?e(t.currentTarget).focus():n?this.$(n).focus():this.$(".origin").focus(),t!=null?t.stopPropagation():void 0},onSubmitMemo:function(){return this.$("form.memo").hide(),this.model.set({memo:this.$("div.memo").show().html(p(this.$("input.memo").val())).text()}),!1},onBlurInputMemo:function(){return this.onSubmitMemo()},onClickRemove:function(){return this.trigger("removeConfig",this.model)},setDispMode:function(e){return this.$("div.mode").addClass(e).find("span").text(y[e]),this.$(".proxy,.origin,.icon-arrow-right").removeClass(this.optionKeys.join(" ")).addClass(e),e==="assignOrg"?(this.$(".origin").attr("tabIndex","0"),this.$("td:first").removeAttr("colspan"),this.$("td:eq(1),td:eq(2)").show()):(this.$(".origin").removeAttr("tabIndex"),this.$("td:first").attr("colspan","3"),this.$("td:eq(1),td:eq(2)").hide())},setKbdValue:function(e,t){var n;this.trigger("decodeKbdEvent",t,n={});if(n.result)return e.html(_.map(n.result.split(" + "),function(e){return"<span>"+e+"</span>"}).join("+"))},setDesc:function(){var e,t,n,r,i,s,o,u,a,f,l,h,p;(a=this.$(".desc")).empty();switch(u=this.model.get("mode")){case"bookmark":l=this.model.get("bookmark").url,a.append('<div class="bookmark" title="'+l+'" style="background-image:-webkit-image-set(url(chrome://favicon/size/16@1x/'+l+') 1x);">'+this.model.get("bookmark").title+"</div>");break;case"command":t=c[this.model.get("command").name],a.append('<div class="commandIcon">Cmd</div><div class="command">'+t+"</div>");break;case"assignOrg":case"through":case"disabled":o=this.kbdtype==="JP"?"ja":"en",u==="assignOrg"?s=this.$(".origin").text():s=this.$(".proxy").text(),s=s.replace(/\s/g,"").toUpperCase(),(n=E[s])||/^CTRL\+[2-7]$/.test(s)&&(n=E["CTRL+1"]);if(n)for(r=h=0,p=n[o].length;0<=p?h<p:h>p;r=0<=p?++h:--h)f=n[o][r].match(/(^\w+)\^(.+)/),i=RegExp.$1,e=RegExp.$2,a.append(this.tmplHelp({sectDesc:S[i],sectKey:i,scHelp:e})).find(".sectInit").tooltip({position:{my:"left+10 top-60"}})}if(a.html()==="")return a.append(this.tmplMemo({memo:this.model.get("memo")}))},tmplMemo:_.template('<div>\n  <i class="icon-pencil" title="Edit description"></i>\n</div>\n<form class="memo">\n  <input type="text" class="memo">\n</form>\n<div class="memo"><%=memo%></div>'),tmplHelp:_.template('<div class="sectInit" title="<%=sectDesc%>"><%=sectKey%></div><div class="content"><%=scHelp%></div>'),template:_.template('<tr class="data">\n  <td>\n    <div class="proxy" tabIndex="0"></div>\n  </td>\n  <td>\n    <i class="icon-arrow-right"></i>\n  </td>\n  <td class="tdOrigin">\n    <div class="origin" tabIndex="0"></div>\n  </td>\n  <td class="options">\n    <div class="mode"><span></span><i class="icon-caret-down"></i></div>\n    <div class="selectMode" tabIndex="0">\n      <% _.each(options, function(name, key) { %>\n      <div class="<%=key%>"><%=name%></div>\n      <% }); %>\n    </div>\n  <td class="desc"></td>\n  <td class="remove">\n    <i class="icon-remove" title="Delete"></i>\n  </td>\n  <td class="blank">&nbsp;</td>\n</tr>')}),a=Backbone.View.extend({placeholder:"Enter new shortcut key",el:"table.keyConfigSetView",events:{"blur div.addnew":"onBlurAddnew",click:"onClickBlank"},initialize:function(e){return this.collection.comparator=function(e){return e.get("ordernum")},this.collection.on({add:this.onAddRender,kbdEvent:this.onKbdEvent},this)},render:function(t){var n=this;return this.$el.append(this.template()),this.collection.set(t),this.$("tbody").sortable({delay:300,scroll:!0,cursor:"move",update:function(){return n.onUpdateSort()},start:function(){return n.onStartSort()},stop:function(){return n.onStopSort()}}),e(".fixed-table-container-inner").niceScroll({cursorwidth:12,cursorborderradius:2,smoothscroll:!0,cursoropacitymin:.3,cursoropacitymax:.7,zindex:999998}),this.niceScroll=e(".fixed-table-container-inner").getNiceScroll(),this},onAddRender:function(e){var t,n;return t=new f({model:e}),t.on("decodeKbdEvent",this.onChildDecodeKbdEvent,this),t.on("removeConfig",this.onChildRemoveConfig,this),t.on("resizeInput",this.onChildResizeInput,this),t.on("showUiDialog",this.onShowUiDialog,this),this.$("tbody").append(n=t.render(this.model.get("kbdtype")).$el).append(this.tmplBorder)},onKbdEvent:function(t){var n,r,i,s;if(this.$(".addnew").length===0){if((s=this.$(".proxy:focus,.origin:focus")).length!==0)return;if(n=this.collection.get(t)){n.trigger("setFocus",null,".proxy");return}if(!this.onClickAddKeyConfig())return}if(this.collection.findWhere({proxy:t})){e("#tiptip_content").text('"'+this.decodeKbdEvent(t)+'" is already exists.'),this.$("div.addnew").tipTip();return}return this.$("div.addnew").blur(),~~t.substring(2)>512?i="0130":i=t,this.collection.add(r=new o({proxy:t,origin:i})),this.$("tbody").sortable("enable").sortable("refresh"),T(),this.onChildResizeInput(),r.trigger("setFocus")},onChildDecodeKbdEvent:function(e,t){return t.result=this.decodeKbdEvent(e)},onChildRemoveConfig:function(e){return this.collection.remove(e),this.onStopSort(),T(),this.onChildResizeInput()},onChildResizeInput:function(){var e=this;return this.$(".th_inner").css("left",0),setTimeout(function(){return e.$(".th_inner").css("left","")},0)},onShowUiDialog:function(e,t,n){return this.trigger("showUiDialog",e,t,n)},onSetBookmark:function(e,t){return this.collection.get(e).set({bookmark:t},{silent:!0}).trigger("change:bookmark")},onSetCommand:function(e,t){return this.collection.get(e).set({command:t},{silent:!0}).trigger("change:command")},onClickAddKeyConfig:function(t){if(this.$(".addnew").length>0)return;return this.collection.length>50?(e("#tiptip_content").text("You have reached the maximum number of items. (Max 50 items)"),e(t.currentTarget).tipTip({defaultPosition:"left"}),!1):(e(this.tmplAddNew({placeholder:this.placeholder})).appendTo(this.$("tbody")).find(".addnew").focus()[0].scrollIntoView(),this.$("tbody").sortable("disable"),T(),!0)},onClickBlank:function(){return this.$(":focus").blur()},onBlurAddnew:function(){return this.$(".addnew").remove(),this.$("tbody").sortable("enable"),T()},onChangeSelKbd:function(e){var t;return m=v[t=e.currentTarget.value].keys,this.collection.trigger("changeKbd",t),this.model.set("kbdtype",t)},onStartSort:function(){return this.$(".ui-sortable-placeholder").next("tr.border").remove()},onStopSort:function(){var t,n=this;e.each(this.$("tbody tr"),function(t,r){var i,s,o;if(r.className==="data"){if(((s=e(r).next("tr")[0])!=null?s.className:void 0)!=="border")return e(r).after(n.tmplBorder)}else if(((o=(i=e(r).next("tr"))[0])!=null?o.className:void 0)!=="data")return i.remove()});if((t=this.$("tbody tr:first"))[0].className==="border")return t.remove()},onUpdateSort:function(){return this.collection.trigger("updateOrder"),this.collection.sort()},decodeKbdEvent:function(e){var t,n,r,i;return r=parseInt(e.substring(0,2),16),i=e.substring(2),n=m[i],t=[],r&1&&t.push("Ctrl"),r&2&&t.push("Alt"),r&8&&t.push("Win"),r&16&&t.push("MouseL"),r&32&&t.push("MouseR"),r&64&&t.push("MouseM"),r&4?(t.push("Shift"),t.push(n[1]||n[0])):t.push(n[0]),t.join(" + ")},getSaveData:function(){return this.collection.remove(this.collection.findWhere({proxy:this.placeholder})),{config:this.model.toJSON(),keyConfigSet:this.collection.toJSON()}},tmplAddNew:_.template('<tr class="addnew">\n  <td colspan="3">\n    <div class="proxy addnew" tabIndex="0"><%=placeholder%></div>\n  </td>\n  <td></td><td></td><td></td><td class="blank"></td>\n</tr>'),tmplBorder:'<tr class="border">\n  <td colspan="6"><div class="border"></div></td>\n  <td></td>\n</tr>',template:_.template('<thead>\n  <tr>\n    <th>\n      <div class="th_inner">New <i class="icon-arrow-right"></i> Origin shortcut key</div>\n    </th>\n    <th></th>\n    <th></th>\n    <th>\n      <div class="th_inner options">Options</div>\n    </th>\n    <th>\n      <div class="th_inner desc">Description</div>\n    </th>\n    <th></th>\n    <th><div class="th_inner blank">&nbsp;</div></th>\n  </tr>\n</thead>\n<tbody></tbody>')}),g=0,b=!1,T=function(){return b&&clearTimeout(b),b=setTimeout(function(){var t;return t=window.innerHeight-document.querySelector(".header").offsetHeight-g,document.querySelector(".fixed-table-container").style.pixelHeight=t,e(".fixed-table-container-inner").getNiceScroll().resize(),e(".result_outer").getNiceScroll().resize()},200)},d=chrome.extension.getBackgroundPage().fk,w=d.getConfig(),v=d.getKeyCodes(),E=d.getScHelp(),S=d.getScHelpSect(),x=function(){return d.startEditing()},h=function(){return d.endEditing()},e=jQuery,e(function(){var n,o,f,l;return f=new s({model:new i(w.config)}),f.render(),l=new a({model:new i(w.config),collection:new u}),l.render(w.keyConfigSet),n=new t({}),o=new r({}),f.on("clickAddKeyConfig",l.onClickAddKeyConfig,l),f.on("changeSelKbd",l.onChangeSelKbd,l),l.on("showUiDialog",n.onShowUiDialog,n),l.on("showUiDialog",o.onShowUiDialog,o),n.on("setBookmark",l.onSetBookmark,l),o.on("setCommand",l.onSetCommand,l),chrome.runtime.onMessage.addListener(function(e,t,n){switch(e.action){case"kbdEvent":return l.collection.trigger("kbdEvent",e.value);case"saveConfig":return d.saveConfig(l.getSaveData())}}),e(window).on("unload",function(){return d.saveConfig(l.getSaveData())}).on("resize",function(){return T()}),e(".beta").text("β"),T()})}).call(this);