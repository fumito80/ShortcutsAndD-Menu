(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};a=document.getElementById("flexkbd"),g={invoke:function(e,t,n,r){var i;try{return a[e](t||null,n||null,r||null),"done"}catch(s){return i=s,console.log({name:e,value1:t,value2:n,value3:r,error:i}),i.message}}},u=function(e,t,n,r,i,s){var u,a,f,l,c,h,p,d,v,m,w,E,S,x,T,N,C,k;if(!n)throw new Error("Command argument is not found.");m="",v=0,h=fk.getConfig(),E=n.match(/\[(\w*?)\](.+)/),E?(d=RegExp.$1,l=RegExp.$2,p=d.toLowerCase().split(""),O.call(p,"c")>=0&&(v=1),O.call(p,"a")>=0&&(v+=2),O.call(p,"s")>=0&&(v+=4),O.call(p,"w")>=0&&(v+=8)):(v=0,l=n),f=h.config.kbdtype,c=fk.getKeyCodes()[f].keys,w=-1;for(u=S=0,N=c.length;0<=N?S<N:S>N;u=0<=N?++S:--S)if(c[u]&&(l===c[u][0]||l===c[u][1])){w=u;break}if(w===-1)throw new Error("Key identifier code '"+l+"' is unregistered code.");if(!(i==="keydown"||v!==0||O.call(function(){k=[];for(var e=59;e<=68;e++)k.push(e);return k}.apply(this),w)>=0||w===87||w===88))throw new Error("Modifier code is not included in '"+n+"'.");m="0"+v.toString(16)+w;if(!i)for(u=T=0,C=h.keyConfigSet.length;0<=C?T<C:T>C;u=0<=C?++T:--T)if((a=h.keyConfigSet[u])["new"]===m){i=a.mode;break}switch(i){case"command":return o(m).done(function(){return t("done",e,r,s)});case"bookmark":return y(m).done(function(){return t("done",e,r,s)});case"sendToDom":return b(m).done(function(){return t("done",e,r,s)});case"keydown":return setTimeout(function(){var n;return n=g.invoke("CallShortcut",m,8),t(n,e,r,s)},0);default:return setTimeout(function(){var n;return n=g.invoke("CallShortcut",m,4),t(n,e,r,s)},0)}},s=function(e,t,n){var r,i,s,o,a,f,l;o=function(e,t,n,r){return t.resolve(r+1)},(i=s=$.Deferred()).promise(),r=t.value1;for(a=f=0,l=r.length;0<=l?f<l:f>l;a=0<=l?++f:--f)i=i.then(function(t){var i,s,a,f;s=$.Deferred();try{if(isNaN(i=r[t]))u(s,o,i,0,null,t);else{f=Math.round(i);if(!(-1<f&&f<6e4))throw new Error("Range of Sleep millisecond is up to 6000-0.");setTimeout(function(){return g.invoke("Sleep",f),s.resolve(t+1)},0)}}catch(l){a=l,s.reject(),n({msg:a.message}),e.resolve()}return s.promise()});return i=i.then(function(){return n({msg:"done"}),e.resolve()}),s.resolve(0)},i=$.Deferred().resolve(),chrome.runtime.onMessage.addListener(function(e,t,n){var r;return r=function(e,t,r){return r>0&&g.invoke("Sleep",r),n({msg:e}),t.resolve()},i=i.then(function(){var t,i;t=$.Deferred();try{switch(e.action){case"batch":s(t,e,n);break;case"callShortcut":u(t,r,e.value1,e.value2);break;case"keydown":u(t,r,e.value1,e.value2,"keydown");break;case"sleep":setTimeout(function(){var n;return n=g.invoke("Sleep",e.value1),r(n,t,0)},0);break;case"setClipboard":setTimeout(function(){var n;return n=g.invoke("SetClipboard",e.value1),r(n,t,0)},0);break;case"getClipboard":setTimeout(function(){var e,r,i;try{i=a.GetClipboard(),r="done"}catch(s){e=s,i="",r=e.message}return n({msg:r,text:i}),t.resolve()},0)}}catch(o){i=o,n({msg:i.message}),t.resolve()}return t.promise()}),!0}),p='var e,t,tsc;e=function(){function e(e){this.error=e}return e.prototype.done=function(e){return this},e.prototype.fail=function(e){return e(new Error(this.error)),this},e}(),t=function(){function e(){}return e.prototype.done=function(e){return this.doneCallback=e,this},e.prototype.fail=function(e){return this.failCallback=e,this},e.prototype.sendMessage=function(e,t,n,r){var i=this;return chrome.runtime.sendMessage({action:e,value1:t,value2:n,value3:r},function(e){var t;if((e!=null?e.msg:void 0)==="done"){if(t=i.doneCallback)return setTimeout(function(){return t(e.text||e.msg)},0)}else if(t=i.failCallback)return setTimeout(function(){return t(e.msg)},0)}),this},e}(),tsc={batch:function(n){return n instanceof Array?(new t).sendMessage("batch",n):new e("Argument is not Array.")},send:function(n,r){var i;i=100;if(r!=null){if(isNaN(i=r))return new e(r+" is not a number.");i=Math.round(r);if(i<0||i>6e3)return new e("Range of Sleep millisecond is up to 6000-0.")}return(new t).sendMessage("callShortcut",n,i)},keydown:function(n,r){var i;i=100;if(r!=null){if(isNaN(i=r))return new e(r+" is not a number.");i=Math.round(r);if(i<0||i>6e3)return new e("Range of Sleep millisecond is up to 6000-0.")}return(new t).sendMessage("keydown",n,i)},sleep:function(n){if(n!=null){if(isNaN(n))return new e(n+" is not a number.");n=Math.round(n);if(n<0||n>6e3)return new e("Range of Sleep millisecond is up to 6000-0.")}else n=100;return(new t).sendMessage("sleep",n)},clipbd:function(e){return(new t).sendMessage("setClipboard",e)},getClipbd:function(){return(new t).sendMessage("getClipboard")}};',N=function(e){return chrome.tabs.query({active:!0},function(t){return chrome.tabs.sendMessage(t[0].id,e)})},f=function(){var e;return e=$.Deferred(),chrome.windows.getCurrent(null,function(t){return chrome.tabs.query({active:!0,windowId:t.id},function(n){return e.resolve(n[0],t.id)})}),e.promise()},h=function(e){var t;return t=$.Deferred(),chrome.windows.getCurrent(null,function(n){return e.windowId=n.id,chrome.tabs.query(e,function(e){return t.resolve(e)})}),t.promise()},l=function(){var e;return e=$.Deferred(),chrome.tabs.query({},function(t){return e.resolve(t)}),e.promise()},c=function(){var e;return e=$.Deferred(),chrome.windows.getAll({populate:!0},function(t){var n;return n=[],t.forEach(function(e){return n=n.concat(e.tabs)}),e.resolve(n)}),e.promise()},m=null,chrome.tabs.onActivated.addListener(function(e){return chrome.tabs.get(e.tabId,function(t){if(t.url.indexOf(chrome.extension.getURL("options.html"))===0)return a.StartConfigMode(),m=e.tabId;if(m)return chrome.tabs.sendMessage(m,{action:"saveConfig"}),m=null})}),chrome.windows.onFocusChanged.addListener(function(e){return m?(chrome.tabs.sendMessage(m,{action:"saveConfig"}),m=null):f().done(function(e){if(e.url.indexOf(chrome.extension.getURL("options.html"))===0)return a.StartConfigMode(),m=e.id})}),chrome.tabs.onUpdated.addListener(function(e,t,n){if(n.url.indexOf(chrome.extension.getURL("options.html"))===0&&(t.status="complete"))return a.StartConfigMode()}),d={},d.state="closed",chrome.notifications.onButtonClicked.addListener(function(e,t){var n;if(e===chrome.runtime.id)return n=JSON.parse(localStorage.copyHistory||null)||[],g.invoke("PasteText",n[t]),chrome.notifications.clear(chrome.runtime.id,function(){return d.state="closed"})}),chrome.notifications.onClosed.addListener(function(e,t){if(e===chrome.runtime.id)return d.state="closed"}),A=function(){var e,t,n;return t=JSON.parse(localStorage.copyHistory||null)||[],e=[],t.forEach(function(t){if(t)return e.push({title:t,message:"msg"})}),(n=d.state)==="opened"||n==="created"?chrome.notifications.clear(chrome.runtime.id,function(){return chrome.notifications.create(chrome.runtime.id,{type:"list",iconUrl:"images/key_bindings.png",message:"Select text to paste",eventTime:6e4,title:"Copy history",items:e},function(){return d.state="opened"})}):chrome.notifications.create(chrome.runtime.id,{type:"list",iconUrl:"images/key_bindings.png",message:"Select text to paste",eventTime:6e4,title:"Copy history",items:e},function(){return d.state="opened"})},L=function(e,t){return A(),e.resolve()},C=function(e,t){return setTimeout(function(){if(e.state()==="pending")return e.resolve()},200),chrome.tabs.sendMessage(t,{action:"copyText"},function(t){var n,r,i,s;if(t!==""){g.invoke("SetClipboard",t),n=JSON.parse(localStorage.copyHistory||null)||[];for(r=i=0,s=n.length;0<=s?i<s:i>s;r=0<=s?++i:--i)if(n[r]===t){n.splice(r,1);break}n.unshift(t),n.length>20&&n.pop(),localStorage.copyHistory=JSON.stringify(n),d.state==="opened"&&A()}return e.resolve()})},T=function(e,t){var n,r,i,s,o,u,a;return s=fk.getConfig(),i=fk.getKeyCodes()[s.config.kbdtype].keys,o=parseInt(e.substring(0,2),16),u=e.substring(2),r=i[u],(a=(o&4)!==0)?n=r[1]||r[0]:n=r[0],chrome.tabs.sendMessage(t,{action:"keyEvent",keyIdentifier:n,ctrl:(o&1)!==0,alt:(o&2)!==0,shift:a,meta:(o&8)!==0})},b=function(e){var t;return t=$.Deferred(),f().done(function(n){return chrome.tabs.sendMessage(n.id,{action:"askAlive"},function(r){return r==="hello"?(T(e,n.id),t.resolve()):chrome.tabs.executeScript(n.id,{file:"kbdagent.js",allFrames:!0,runAt:"document_end"},function(r){return T(e,n.id),t.resolve()})})}),t.promise()},v=function(e,t,n){switch(t){case"newtab":return chrome.tabs.create({url:n},function(){return e.resolve()});case"current":return chrome.tabs.query({active:!0},function(t){return chrome.tabs.update(t[0].id,{url:n},function(){return e.resolve()})});case"newwin":return chrome.windows.create({url:n},function(){return e.resolve()});case"incognito":return chrome.windows.create({url:n,incognito:!0},function(){return e.resolve()});default:return e.resolve()}},y=function(e){var t,n;return t=$.Deferred(),n=fk.getConfig(),n.keyConfigSet.forEach(function(n){var r,i,s,o,u;if(n["new"]===e)return u=n.bookmark,s=u.openmode,o=u.url,i=u.findtab,r=u.findStr,i?f().done(function(e){return l().done(function(n){var i,u,a,f,l,c,h,p;i=0;for(a=l=0,h=n.length;0<=h?l<h:l>h;a=0<=h?++l:--l)if(n[a].id===e.id){i=a;break}f=[],0<i&&i<n.length-1?f=n.slice(i+1).concat(n.slice(0,i+1)):f=n,u=!1;for(a=c=0,p=f.length;0<=p?c<p:c>p;a=0<=p?++c:--c)if((f[a].title+f[a].url).indexOf(r)!==-1){chrome.tabs.update(f[a].id,{active:!0},function(){return t.resolve()}),u=!0;break}if(!u)return v(t,s,o)})}):v(t,s,o)}),t.promise()},r=function(e,t,n){var i;return(i=t[n])?chrome.history.deleteUrl({url:i},function(){return r(e,t,n+1)}):e.resolve()},n=function(e,t,r){var i;return(i=t[r])?i.focused?n(e,t,r+1):chrome.windows.remove(i.id,function(){return n(e,t,r+1)}):e.resolve()},t=function(e,t){return h({active:!1,currentWindow:!0,windowType:"normal"},t).done(function(n){var r;r=[],n.forEach(function(e){if(t(e))return r.push(e.id)});if(r.length>0)return chrome.tabs.remove(r,function(){return e.resolve()})})},o=function(e){var i,s,o;return i=$.Deferred(),s=fk.getConfig(),o=0,s.keyConfigSet.forEach(function(s){var u,a,l;if(s["new"]===e)switch(a=s.command.name){case"createTab":return f().done(function(e,t){return chrome.tabs.create({windowId:t,index:e.index+1},function(){return i.resolve()})});case"closeOtherTabs":return t(i,function(){return!0});case"closeTabsRight":case"closeTabsLeft":return f().done(function(e){return o=e.index,a==="closeTabsRight"?t(i,function(e){return e.index>o}):t(i,function(e){return e.index<o})});case"moveTabRight":case"moveTabLeft":return f().done(function(e,t){var n;n=e.index,a==="moveTabRight"?n+=1:n-=1;if(n>-1)return chrome.tabs.move(e.id,{windowId:t,index:n},function(){return i.resolve()})});case"moveTabFirst":return f().done(function(e,t){return chrome.tabs.move(e.id,{windowId:t,index:0},function(){return i.resolve()})});case"moveTabLast":return f().done(function(e,t){return chrome.tabs.move(e.id,{windowId:t,index:1e3},function(){return i.resolve()})});case"detachTab":return f().done(function(e,t){return chrome.windows.create({tabId:e.id,focused:!0,type:"normal"},function(){return i.resolve()})});case"attachTab":return f().done(function(e,t){return chrome.windows.getAll({populate:!0},function(t){var n,r,s,o,u,a,f,l,c;for(r=a=0,l=t.length;0<=l?a<l:a>l;r=0<=l?++a:--a)for(s=f=0,c=t[r].tabs.length;0<=c?f<c:f>c;s=0<=c?++f:--f)if(e.id===t[r].tabs[s].id){n=r;break}return(u=t[++n])?o=u.id:o=t[0].id,chrome.tabs.move(e.id,{windowId:o,index:1e3},function(){return chrome.tabs.update(e.id,{active:!0},function(){return i.resolve()})})})});case"duplicateTab":return f().done(function(e,t){return chrome.tabs.duplicate(e.id,function(){return i.resolve()})});case"duplicateTabWin":return f().done(function(e,t){return chrome.tabs.duplicate(e.id,function(e){return chrome.windows.create({tabId:e.id,focused:!0,type:"normal"},function(){return i.resolve()})})});case"pinTab":return f().done(function(e,t){return chrome.tabs.update(e.id,{pinned:!e.pinned},function(){return i.resolve()})});case"switchNextWin":return chrome.windows.getAll(null,function(e){var t,n,r,s;s=[];for(t=n=0,r=e.length;0<=r?n<r:n>r;t=0<=r?++n:--n){if(e[t].focused){t===e.length-1?chrome.windows.update(e[0].id,{focused:!0},function(){return i.resolve()}):chrome.windows.update(e[t+1].id,{focused:!0},function(){return i.resolve()});break}s.push(void 0)}return s});case"switchPrevWin":return chrome.windows.getAll(null,function(e){var t,n,r,s;s=[];for(t=n=0,r=e.length;0<=r?n<r:n>r;t=0<=r?++n:--n){if(e[t].focused){t===0?chrome.windows.update(e[e.length-1].id,{focused:!0},function(){return i.resolve()}):chrome.windows.update(e[t-1].id,{focused:!0},function(){return i.resolve()});break}s.push(void 0)}return s});case"closeOtherWins":return chrome.windows.getAll(null,function(e){return n(i,e,0)});case"pasteText":return setTimeout(function(){return g.invoke("PasteText",s.command.content),i.resolve()},0);case"copyText":return f().done(function(e){return chrome.tabs.sendMessage(e.id,{action:"askAlive"},function(t){return t==="hello"?C(i,e.id):chrome.tabs.executeScript(e.id,{file:"kbdagent.js",allFrames:!0,runAt:"document_end"},function(t){return C(i,e.id)})})});case"showHistory":return f().done(function(e){return chrome.tabs.sendMessage(e.id,{action:"askAlive"},function(t){return t==="hello"?L(i,e.id):chrome.tabs.executeScript(e.id,{file:"kbdagent.js",allFrames:!0,runAt:"document_end"},function(t){return L(i,e.id)})})});case"insertCSS":return f().done(function(e){return chrome.tabs.insertCSS(e.id,{code:s.command.content,allFrames:s.command.allFrames},function(){return i.resolve()})});case"execJS":return u=s.command.content,s.command.useUtilObj&&(u=p+u),f().done(function(e){return chrome.tabs.executeScript(e.id,{code:u,allFrames:s.command.allFrames,runAt:"document_end"},function(){return i.resolve()})});case"clearHistory":return chrome.browsingData.removeHistory({},function(){return i.resolve()});case"clearHistoryS":return l=s.command.content,chrome.history.search({text:"",startTime:0,maxResults:1e4},function(e){var t,n,s,o,u;t=[];for(s=o=0,u=e.length;0<=u?o<u:o>u;s=0<=u?++o:--o)n=e[s],(n.title+n.url).indexOf(l)!==-1&&t.push(n.url);if(t.length>0)return r(i,t,0)});case"clearDownloads":return chrome.browsingData.removeDownloads({},function(){return i.resolve()});case"clearCache":return chrome.browsingData.removeCache({},function(){return i.resolve()})}}),i.promise()},k=function(e){var t;t=[];if(e)return e.forEach(function(e){if(e["new"])return t.push([e["new"],e.origin,e.mode].join(";"))}),a.SetKeyConfig(t.join("|"))},window.fk={saveConfig:function(e){return localStorage.flexkbd=JSON.stringify(e),k(e.keyConfigSet)},getKeyCodes:function(){return{JP:{keys:keysJP,name:"JP 109 Keyboard"},US:{keys:keysUS,name:"US 104 Keyboard"}}},getScHelp:function(){return w},getScHelpSect:function(){return S},getConfig:function(){return JSON.parse(localStorage.flexkbd||null)||{config:{kbdtype:"JP"}}},startEdit:function(){return a.EndConfigMode()},endEdit:function(){return a.StartConfigMode()}},window.pluginEvent=function(e,t){switch(e){case"log":return console.log(t);case"configKeyEvent":return N({action:"kbdEvent",value:t});case"sendToDom":return b(t);case"bookmark":return y(t);case"command":return o(t)}},k(fk.getConfig().keyConfigSet),w={},S={},E="https://support.google.com/chrome/answer/157179?hl=",x=function(e,t,n){var r;return r=$(n).find("tr:has(td:first-child:has(strong))"),$.each(r,function(n,r){var i;return i=r.cells[1].textContent.replace(/^\s+|\s$/g,""),Array.prototype.forEach.call(r.childNodes[1].getElementsByTagName("strong"),function(n){var r,s;r=n.textContent.toUpperCase().replace(/\s/g,""),r=r.replace("PGUP","PAGEUP").replace("PGDOWN","PAGEDOWN").replace(/DEL$/,"DELETE").replace(/INS$/,"INSERT");if((s=w[r])!=null?!s[e]:!void 0)w[r]||(w[r]={}),w[r][e]=[];return w[r][e].push(t+"^"+i)})})},e=function(e,t){var n,r,i;return n=$(e),r=n.find("div.main-section"),i="",Array.prototype.forEach.call(r[0].children,function(e){switch(e.tagName){case"H3":switch(e.textContent){case"Tab and window shortcuts":case"タブとウィンドウのショートカット":i="T";break;case"Google Chrome feature shortcuts":case"Google Chrome 機能のショートカット":i="C";break;case"Address bar shortcuts":case"アドレスバーのショートカット":i="A";break;case"Webpage shortcuts":case"ウェブページのショートカット":i="W";break;case"Text shortcuts":case"テキストのショートカット":i="Tx"}return S[i]=e.textContent;case"TABLE":return x(t,i,e)}})},$(function(){var t;return t=function(t){var n;return $.get(E+t).done(function(r){return e(r,t),n.resolve()}),(n=$.Deferred()).promise()},t("ja").done(function(){})})}).call(this);