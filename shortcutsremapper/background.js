(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;window.fk={},r=document.getElementById("flexkbd"),v=function(e){return chrome.tabs.query({active:!0},function(t){return chrome.tabs.sendMessage(t[0].id,e)})},s=function(){var e;return e=$.Deferred(),chrome.windows.getCurrent(null,function(t){return chrome.tabs.query({active:!0,windowId:t.id},function(n){return e.resolve(n[0],t.id)})}),e.promise()},o=function(e){var t;return t=$.Deferred(),chrome.windows.getCurrent(null,function(n){return e.windowId=n.id,chrome.tabs.query(e,function(e){return t.resolve(e)})}),t.promise()},a=null,chrome.tabs.onActivated.addListener(function(e){return chrome.tabs.get(e.tabId,function(t){if(t.url.indexOf(chrome.extension.getURL(""))===0)return r.StartConfigMode(),a=e.tabId;if(a)return chrome.tabs.sendMessage(a,{action:"saveConfig"}),a=null})}),chrome.windows.onFocusChanged.addListener(function(e){return a?(chrome.tabs.sendMessage(a,{action:"saveConfig"}),a=null):s().done(function(e){if(e.url.indexOf(chrome.extension.getURL(""))===0)return r.StartConfigMode(),a=e.id})}),chrome.tabs.onUpdated.addListener(function(e,t,n){if(n.url.indexOf(chrome.extension.getURL(""))===0&&(t.status="complete"))return r.StartConfigMode()}),d=function(e,t){var n,r,i,s,o,u,a;return s=fk.getConfig(),i=fk.getKeyCodes()[s.config.kbdtype].keys,o=parseInt(e.substring(0,2),16),u=e.substring(2),r=i[u],(a=(o&4)!==0)?n=r[1]||r[0]:n=r[0],chrome.tabs.sendMessage(t,{action:"keyEvent",keyIdentifier:n,ctrl:(o&1)!==0,alt:(o&2)!==0,shift:a,meta:(o&8)!==0})},f=function(e){return chrome.tabs.query({active:!0},function(t){var n;return n=t[0].id,chrome.tabs.sendMessage(n,{action:"askAlive"},function(t){return t==="hello"?d(e,n):chrome.tabs.executeScript(n,{file:"kbdagent.js",allFrames:!0},function(t){return d(e,n)})})})},u=function(e){var t;return t=fk.getConfig(),t.keyConfigSet.forEach(function(t){var n;if(t.proxy===e)return n=t.bookmark.url,chrome.tabs.query({active:!0},function(e){return chrome.tabs.update(e[0].id,{url:n})})})},t=function(e){return o({active:!1,currentWindow:!0,windowType:"normal"},e).done(function(t){var n;n=[],t.forEach(function(t){if(e(t))return n.push(t.id)});if(n.length>0)return chrome.tabs.remove(n)})},n=function(e){var n,r;return n=fk.getConfig(),r=0,n.keyConfigSet.forEach(function(n){var i;if(n.proxy===e)switch(i=n.command.name){case"closeOtherTabs":return t(function(){return!0});case"closeTabsRight":case"closeTabsLeft":return s().done(function(e){return r=e.index,i==="closeTabsRight"?t(function(e){return e.index>r}):t(function(e){return e.index<r})});case"moveTabRight":case"moveTabLeft":return s().done(function(e,t){var n;return n=e.index,i==="moveTabRight"?n+=1:n-=1,chrome.tabs.move(e.id,{windowId:t,index:n>-1?n:void 0})});case"moveTabFirst":return s().done(function(e,t){return chrome.tabs.move(e.id,{windowId:t,index:0})});case"moveTabLast":return s().done(function(e,t){return chrome.tabs.move(e.id,{windowId:t,index:1e3})});case"detachTab":return s().done(function(e,t){return chrome.windows.create({tabId:e.id,focused:!0,type:"normal"})});case"duplicateTab":return s().done(function(e,t){return chrome.tabs.duplicate(e.id)});case"duplicateTabWin":return s().done(function(e,t){return chrome.tabs.duplicate(e.id,function(e){return chrome.windows.create({tabId:e.id,focused:!0,type:"normal"})})});case"switchNextWin":return chrome.windows.getAll(null,function(e){var t,n,r,i;i=[];for(t=n=0,r=e.length;0<=r?n<r:n>r;t=0<=r?++n:--n){if(e[t].focused){t===e.length-1?chrome.windows.update(e[0].id,{focused:!0}):chrome.windows.update(e[t+1].id,{focused:!0});break}i.push(void 0)}return i});case"switchPrevWin":return chrome.windows.getAll(null,function(e){var t,n,r,i;i=[];for(t=n=0,r=e.length;0<=r?n<r:n>r;t=0<=r?++n:--n){if(e[t].focused){t===0?chrome.windows.update(e[e.length-1].id,{focused:!0}):chrome.windows.update(e[t-1].id,{focused:!0});break}i.push(void 0)}return i})}})},m=function(e){var t;t=[];if(e)return e.forEach(function(e){if(e.proxy)return t.push(e.proxy+";"+e.origin+";"+e.mode)}),r.SetKeyConfig(t.join("|"))},fk.saveConfig=function(e){return localStorage.flexkbd=JSON.stringify(e),m(e.keyConfigSet)},fk.getKeyCodes=function(){return{JP:{keys:keysJP,name:"JP 109 Keyboard"},US:{keys:keysUS,name:"US 104 Keyboard"}}},fk.getScHelp=function(){return l},fk.getScHelpSect=function(){return h},fk.getConfig=function(){return JSON.parse(localStorage.flexkbd||null)||{config:{kbdtype:"JP"}}},fk.startEditing=function(){return r.EndConfigMode()},fk.endEditing=function(){return r.StartConfigMode()},window.pluginEvent=function(e,t){switch(e){case"log":return console.log(t);case"configKeyEvent":return v({action:"kbdEvent",value:t});case"sendToDom":return f(t);case"bookmark":return u(t);case"command":return n(t)}},m(fk.getConfig().keyConfigSet),l={},h={},c="https://support.google.com/chrome/answer/157179?hl=",p=function(e,t,n){var r;return r=$(n).find("tr:has(td:first-child:has(strong))"),$.each(r,function(n,r){var i;return i=r.cells[1].textContent.replace(/^\s+|\s$/g,""),Array.prototype.forEach.call(r.childNodes[1].getElementsByTagName("strong"),function(n){var r,s;r=n.textContent.toUpperCase().replace(/\s/g,""),r=r.replace("PGUP","PAGEUP").replace("PGDOWN","PAGEDOWN").replace(/DEL$/,"DELETE").replace(/INS$/,"INSERT");if((s=l[r])!=null?!s[e]:!void 0)l[r]||(l[r]={}),l[r][e]=[];return l[r][e].push(t+"^"+i)})})},e=function(e,t){var n,r,i;return n=$(e),r=n.find("div.main-section"),i="",Array.prototype.forEach.call(r[0].children,function(e){switch(e.tagName){case"H3":switch(e.textContent){case"Tab and window shortcuts":case"タブとウィンドウのショートカット":i="T";break;case"Google Chrome feature shortcuts":case"Google Chrome 機能のショートカット":i="C";break;case"Address bar shortcuts":case"アドレスバーのショートカット":i="A";break;case"Webpage shortcuts":case"ウェブページのショートカット":i="W";break;case"Text shortcuts":case"テキストのショートカット":i="Tx"}return h[i]=e.textContent;case"TABLE":return p(t,i,e)}})},g=new XMLHttpRequest,i=function(t){var n;return g.onreadystatechange=function(){if(g.readyState===4&&g.status===200)return e(g.responseText,t),n.resolve()},g.open("GET",c+t,!0),g.send(),(n=$.Deferred()).promise()},i("ja").done(function(){return i("en")})}).call(this);