// Generated by CoffeeScript 1.6.3
(function() {
  var flexkbd, optionTabId, preSendKeyEvent, sendKeyEventToDom, sendMessage, setConfigPlugin;

  window.fk = {};

  flexkbd = document.getElementById("flexkbd");

  sendMessage = function(message) {
    return chrome.tabs.query({
      active: true
    }, function(tabs) {
      return chrome.tabs.sendMessage(tabs[0].id, message);
    });
  };

  optionTabId = null;

  chrome.tabs.onActivated.addListener(function(activeInfo) {
    return chrome.tabs.get(activeInfo.tabId, function(tab) {
      if (tab.url.indexOf(chrome.extension.getURL("")) === 0) {
        flexkbd.StartConfigMode();
        return optionTabId = activeInfo.tabId;
      } else {
        if (optionTabId) {
          chrome.tabs.sendMessage(optionTabId, {
            action: "saveConfig"
          });
          return optionTabId = null;
        }
      }
    });
  });

  chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
    if (tab.url.indexOf(chrome.extension.getURL("")) === 0 && (changeInfo.status = "complete")) {
      return flexkbd.StartConfigMode();
    }
  });

  sendKeyEventToDom = function(keyEvent, tabId) {
    var keyIdentifier, keyIdentifiers, keys, local, modifiers, scanCode, shift;
    local = fk.getConfig();
    keys = fk.getKeyCodes()[local.config.kbdtype].keys;
    modifiers = parseInt(keyEvent.substring(0, 2), 16);
    scanCode = keyEvent.substring(2);
    keyIdentifiers = keys[scanCode];
    if (shift = (modifiers & 4) !== 0) {
      keyIdentifier = keyIdentifiers[1] || keyIdentifiers[0];
    } else {
      keyIdentifier = keyIdentifiers[0];
    }
    return chrome.tabs.sendMessage(tabId, {
      action: "keyEvent",
      keyIdentifier: keyIdentifier,
      ctrl: (modifiers & 1) !== 0,
      alt: (modifiers & 2) !== 0,
      shift: shift,
      meta: (modifiers & 8) !== 0
    });
  };

  preSendKeyEvent = function(keyEvent) {
    return chrome.tabs.query({
      active: true
    }, function(tabs) {
      var tabId;
      tabId = tabs[0].id;
      return chrome.tabs.sendMessage(tabId, {
        action: "askAlive"
      }, function(resp) {
        if (resp === "hello") {
          return sendKeyEventToDom(keyEvent, tabId);
        } else {
          return chrome.tabs.executeScript(tabId, {
            file: "kbdagent.js",
            allFrames: true
          }, function(resp) {
            return sendKeyEventToDom(keyEvent, tabId);
          });
        }
      });
    });
  };

  setConfigPlugin = function(keyConfigSet) {
    var sendData;
    sendData = [];
    if (keyConfigSet) {
      keyConfigSet.forEach(function(item) {
        if (item.disShortcut) {
          return sendData.push(item.disShortcut + ";" + item.newShortcut + ";" + item.option);
        }
      });
      return flexkbd.SetKeyConfig(sendData.join("|"));
    }
  };

  fk.saveConfig = function(saveData) {
    localStorage.flexkbd = JSON.stringify(saveData);
    return setConfigPlugin(saveData.keyConfigSet);
  };

  fk.getKeyCodes = function() {
    return {
      JP: {
        keys: keysJP,
        name: "JP 109 Keyboard"
      },
      US: {
        keys: keysUS,
        name: "US 104 Keyboard"
      }
    };
  };

  fk.getConfig = function() {
    return JSON.parse(localStorage.flexkbd || null) || {
      config: {
        kbdtype: "JP"
      }
    };
  };

  window.pluginEvent = function(action, value) {
    switch (action) {
      case "log":
        return console.log(value);
      case "configKeyEvent":
        return sendMessage({
          action: "kbdEvent",
          value: value
        });
      case "sendToDom":
        return preSendKeyEvent(value);
    }
  };

  setConfigPlugin(fk.getConfig().keyConfigSet);

}).call(this);
