(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt={}.hasOwnProperty,it=function(e,t){function r(){this.constructor=e}for(var n in t)rt.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},st=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};B=null,F=null,C=null,S=null,T=null,L=null,k=null,y=Backbone.View.extend({initialize:function(e){return F.on("showPopup",this.onShowPopup,this)},events:{"submit form":"onSubmitForm","click  .icon-remove":"onClickIconRemove"},render:function(){},onSubmitForm:function(){},onShowPopup:function(t,n,r){var i,s,o,u,a=this;if(t!==this.name)return!1;this.options=r;if(this.model=n)s="",/^C/.test(i=n.get("new"))?(u=A(o=n.get("parentId")),e.each(n.collection.where({parentId:o}),function(e,t){if(t.id===i)return s="-#"+(e+1),!1})):u=A(i),this.$(".shortcut").html(_.map(u.split(" + "),function(e){return"<span>"+e+"</span>"}).join("+")+s),n.trigger("showPopup",!0);return this.render(),this.$el.show().draggable({cursor:"move",delay:200,cancel:"input,textarea,button,select,option,.bookmarkPanel,span.contexts,span.menuCaption,span.title",stop:function(){return a.onStopDrag()}}),this.el.style.pixelLeft=Math.round((window.innerWidth-this.el.offsetWidth)/2),this.el.style.pixelTop=Math.round((window.innerHeight-this.el.offsetHeight)/2),this.$(".caption").focus(),e(".backscreen").show()},onStopDrag:function(){},onClickIconRemove:function(){return this.hidePopup()},hidePopup:function(){var t;return e(".backscreen").hide(),this.$el.hide(),(t=this.model)!=null?t.trigger("showPopup",!1):void 0},tmplHelp:_.template('<a href="helpview.html#<%=name%>" target="helpview" class="help" title="help">\n  <i class="icon-question-sign" title="Help"></i>\n</a>')}),c=function(e){function t(){return Z=t.__super__.constructor.apply(this,arguments),Z}return it(t,e),t.prototype.onShowPopup=function(e,n,r){return t.__super__.onShowPopup.call(this,e,n,r)?K():!1},t.prototype.hidePopup=function(){return M(),t.__super__.hidePopup.call(this)},t}(y),h=function(e){function t(e){var n;t.__super__.constructor.call(this,e),n=document.getCSSCanvasContext("2d","triangle",10,6),n.translate(.5,.5),n.fillStyle="#000000",n.beginPath(),n.moveTo(8,0),n.lineTo(8,.5),n.lineTo(3.5,4.5),n.lineTo(0,.5),n.lineTo(0,0),n.closePath(),n.fill(),n.stroke(),this.$(".result_outer").niceScroll({cursorwidth:12,cursorborderradius:6,smoothscroll:!0,cursoropacitymin:.1,cursoropacitymax:.6}),this.elResult$=this.$(".result")}return it(t,e),t.prototype.events=_.extend({"click .expand-icon":"onClickExpandIcon","click .expandAll":"onClickExpandAll"},y.prototype.events),t.prototype.onShowPopup=function(e,n,r){return t.__super__.onShowPopup.call(this,e,n,r)?this.$(".result_outer").getNiceScroll().show():!1},t.prototype.onStopDrag=function(){return this.$(".result_outer").getNiceScroll().resize()},t.prototype.hidePopup=function(){return this.$(".result_outer").getNiceScroll().hide(),t.__super__.hidePopup.call(this)},t.prototype.onClickExpandAll=function(){return this.$(".expandAll").is(":checked")?this.$(".folder,.contexts").addClass("opened expanded"):this.$(".folder,.contexts").removeClass("opened expanded"),Y()},t}(y),N={createTab:["tab","Create new tab"],createTabBG:["tab","Create new tab in background"],moveTabLeft:["tab","Move current tab left"],moveTabRight:["tab","Move current tab right"],moveTabFirst:["tab","Move current tab to first position"],moveTabLast:["tab","Move current tab to last position"],closeOtherTabs:["tab","Close other tabs"],closeTabsLeft:["tab","Close tabs to the left"],closeTabsRight:["tab","Close tabs to the right"],duplicateTab:["tab","Duplicate current tab"],pinTab:["tab","Pin/Unpin current tab"],detachTab:["tab","Detach current tab"],attachTab:["tab","Attach current tab to the next window"],switchPrevWin:["win","Switch to the previous window"],switchNextWin:["win","Switch to the next window"],closeOtherWins:["win","Close other windows"],clearCache:["clr","Clear the browser's cache"],clearCookiesAll:["clr","Clear the browser's cookies and site data"],clearCookies:["clr","Clear all cookies for the current domain"],pasteText:["custom","Paste fixed text",[],"Clip"],insertCSS:["custom","Inject CSS",[{value:"allFrames",caption:"All frames"}],"CSS"],execJS:["custom","Inject script",[{value:"allFrames",caption:"All frames"},{value:"useUtilObj",caption:'Use <a href="helpview.html#utilobj" target="helpview">utility object</a>'}],"JS"]},x={tab:"Tab commands",win:"Window commands",clr:"Browsing data commands",clip:"Clipboard commands",custom:"Other"},r=function(t){function n(e){n.__super__.constructor.call(this,e),C.on("showPopup",this.onShowPopup,this)}return it(n,t),n.prototype.name="commandOptions",n.prototype.el=".commandOptions",n.prototype.render=function(){var e,t,n,r=this;return n=this.$(".content").css("height","auto"),(e=this.options.name)==="clearHistoryS"?n.attr("rows","1"):n.attr("rows","10"),this.$(".command").html(N[e][1]),this.$(".caption").val(this.options.caption),n.val(this.options.content),t=this.$(".inputs").empty(),N[e][2].forEach(function(e){return e.checked="",r.options[e.value]&&(e.checked="checked"),t.append(r.tmplOptions(e))}),this.$el.append(this.tmplHelp(this))},n.prototype.onShowPopup=function(e,t,r){if(!n.__super__.onShowPopup.call(this,e,t,r))return;return this.options.content?this.$(".content").focus()[0].setSelectionRange(0,0):this.$(".caption").focus()},n.prototype.onSubmitForm=function(){var t,n,r,i=this;return(n=this.$(".content").val())!==""&&(r={},e.each(this.$(".inputs input[type='checkbox']"),function(e,t){r[t.value]=t.checked}),(t=this.$(".caption").val())||(t=n.split("\n")[0]),this.model.set({command:_.extend({name:this.options.name,caption:t,content:n},r)},{silent:!0}).trigger("change:command"),this.hidePopup()),!1},n.prototype.tmplOptions=_.template('<label>\n  <input type="checkbox" value="<%=value%>" <%=checked%>> <%=caption%>\n</label><br>'),n}(c),i=function(e){function t(){return et=t.__super__.constructor.apply(this,arguments),et}return it(t,e),t.prototype.name="command",t.prototype.el=".commands",t.prototype.render=function(){var e,t,n;n=this.$(".commandRadios"),n.empty(),e=[];for(t in N)e.push(N[t][0]);e=_.unique(e),e.forEach(function(e){return n.append('<div class="cat'+e+'"><div class="catname">'+x[e]+"</div>")});for(t in N)n.find(".cat"+N[t][0]).append(this.tmplItem({key:t,value:N[t][1]}));return this},t.prototype.onShowPopup=function(e,n,r){if(!t.__super__.onShowPopup.call(this,e,n))return;return r&&this.$(".radioCommand").val([r.name]),this.$el.append(this.tmplHelp(this))},t.prototype.onSubmitForm=function(){var e;if(e=this.$(".radioCommand:checked").val())this.hidePopup(),N[e][2]?this.trigger("showPopup","commandOptions",this.model,{name:e}):this.model.set({command:{name:e}},{silent:!0}).trigger("change:command");return!1},t.prototype.tmplItem=_.template('<div>\n  <label>\n    <input type="radio" name="radioCommand" class="radioCommand" value="<%=key%>">\n    <%=value%>\n  </label>\n</div>'),t}(y),t=function(t){function n(e){n.__super__.constructor.call(this,e),S.on("showPopup",this.onShowPopup,this)}return it(n,t),n.prototype.name="bookmarkOptions",n.prototype.el=".bookmarkOptions",n.prototype.events=_.extend({"click input[value='findtab']":"onClickFindTab","change input[name='openmode']:radio":"onChangeOpenmode"},y.prototype.events),n.prototype.render=function(){var e,t;return n.__super__.render.call(this),this.$(".bookmark").css("background-image","-webkit-image-set(url(chrome://favicon/size/16@1x/"+this.options.url+") 1x)").text(this.options.title),this.$(".url").text(this.options.url),this.$(".findStr").val(this.options.findStr||this.options.url),this.$("input[value='"+(this.options.openmode||"current")+"']")[0].checked=!0,(e=this.$("input[value='findtab']")[0]).checked=(t=this.options.findtab)===void 0?!0:t,this.onClickFindTab({currentTarget:e}),this.$el.append(this.tmplHelp(this))},n.prototype.onSubmitForm=function(){var t,n=this;return t={},e.each(this.$("form input[type='checkbox']"),function(e,n){t[n.value]=n.checked}),t.findtab=this.$("input[value='findtab']").is(":checked"),t.openmode=this.$("input[name='openmode']:checked").attr("value"),t.findStr=this.$(".findStr").val(),this.model.set({bookmark:_.extend(this.options,t)},{silent:!0}).trigger("change:bookmark"),this.hidePopup(),!1},n.prototype.onChangeOpenmode=function(e){var t,n;return n=this.$("input[name='openmode']:checked").val(),t=this.$("input[value='findtab']"),n==="findonly"?t.attr("disabled","disabled")[0].checked=!0:t.removeAttr("disabled"),this.onClickFindTab({currentTarget:{checked:t[0].checked}})},n.prototype.onClickFindTab=function(e){return e.currentTarget.checked?this.$(".findStr").removeAttr("disabled"):this.$(".findStr").attr("disabled","disabled").blur()},n}(c),n=function(t){function n(){return tt=n.__super__.constructor.apply(this,arguments),tt}return it(n,t),n.prototype.name="bookmark",n.prototype.el=".bookmarks",n.prototype.events=_.extend({"click  a":"onClickBookmark","click .title":"onClickFolder","click .expand-icon":"onClickExpandIcon"},h.prototype.events),n.prototype.render=function(){var e;return e=window.innerHeight-60,this.$(".result_outer").height(e-35),this.$el.height(e),this.$(".result").children().length===0&&this.onSubmitForm(),this},n.prototype.onShowPopup=function(e,t){var r;if(!n.__super__.onShowPopup.call(this,e,t))return;if((r=this.$("input.query")).val())return r.focus()},n.prototype.onSubmitForm=function(){var t,n,r=this;return this.$(".result").empty(),t=this.$("input.query").focus().val(),t&&(this.$(".expandAll")[0].checked=!0),n=this.$(".expandAll").is(":checked")?"opened expanded":"",chrome.bookmarks.getTree(function(i){var s;return i.forEach(function(e){return r.digBookmarks(e,r.elResult$,t,0,n)}),r.elResult$.append(s=e(r.tmplFolder({title:"Recent",state:n,indent:0}))),s.find(".title").prepend('<img src="images/star.png">'),chrome.bookmarks.getRecent(50,function(e){return e.forEach(function(e){return r.digBookmarks(e,s,t,1,n)})})}),!1},n.prototype.digBookmarks=function(t,n,r,i,s){var o,u=this;if(t.title){t.state=s;if(t.children)t.indent=i,n.append(o=e(this.tmplFolder(t))),n=o;else if(!r||(t.title+" "+t.url).toUpperCase().indexOf(r.toUpperCase())>-1)t.indent=i+1,n.append(e(this.tmplLink(t)))}else i--;if(t.children)return n.parent().addClass("hasFolder"),t.children.forEach(function(e){return u.digBookmarks(e,n,r,i+1,s)})},n.prototype.onClickFolder=function(t){var n,r;return r=(n=e(t.currentTarget).parent()).hasClass("opened"),r?n.removeClass("opened expanded"):n.addClass("opened expanded"),Y(),t.stopPropagation()},n.prototype.onClickExpandIcon=function(t){var n,r;return n=(r=e(t.currentTarget).parent()).hasClass("expanded"),n?r.removeClass("expanded"):r.addClass("expanded"),Y(),t.stopPropagation()},n.prototype.onClickBookmark=function(t){var n;return this.hidePopup(),n=e(t.currentTarget),this.trigger("showPopup","bookmarkOptions",this.model,{title:n.text(),url:n.attr("title"),bmId:n.attr("data-id")}),!1},n.prototype.tmplFolder=_.template('<div class="folder <%=state%>" style="text-indent:<%=indent%>em">\n  <span class="expand-icon"></span><span class="title"><%=title%></span>\n</div>'),n.prototype.tmplLink=_.template('<div class="link" style="text-indent:<%=indent%>em;">\n  <a href="#" title="<%=url%>" data-id="<%=id%>" style="background-image:-webkit-image-set(url(\'chrome://favicon/size/16@1x/<%=url%>\') 1x);"><%=title%></a>\n</div>'),n}(h),Q={page:["Return the page URL","icon-file-alt"],selection:["Return the selection text","icon-font"],editable:["Return the page URL or selection text","icon-edit"],link:["Return the link URL","icon-link"],image:["Return the image URL","icon-picture"],all:["Return any of the above","icon-asterisk"]},H=function(e){var t;return t=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},e+[t(),t()].join("").toUpperCase()+(new Date/1e3|0)},l=function(t){function n(){return nt=n.__super__.constructor.apply(this,arguments),nt}return it(n,t),n.prototype.name="ctxMenuOptions",n.prototype.el=".ctxMenuOptions",n.prototype.events=_.extend({"click  .done,.delete":"onClickSubmit","change .selectParent":"onChangeSelectParent","click  .selectParent":"onClickSelectParent","focus  .parentName":"onFocusParentName","blur   .parentName":"onBlurParentName"},y.prototype.events),n.prototype.render=function(){var e,t,n,r,i,s,o,u;return(this.ctxMenu=this.model.get("ctxMenu"))&&this.ctxMenu.parentId!=="route"&&(this.ctxMenu.contexts=this.collection.get(this.ctxMenu.parentId).get("contexts")),this.$(".caption").val(((s=this.ctxMenu)!=null?s.caption:void 0)||this.options.desc),this.$el.append(this.tmplHelp(this)),this.$("input[value='"+((e=(o=this.ctxMenu)!=null?o.contexts:void 0)||"page")+"']")[0].checked=!0,this.ctxMenu?this.$(".delete").addClass("orange").removeClass("disabled").removeAttr("disabled"):this.$(".delete").removeClass("orange").addClass("disabled").attr("disabled","disabled"),n=(i=this.$(".selectParent")).val(),t=this.$("input[name='ctxType']:checked").attr("value"),i.html(this.tmplParentMenu),this.collection.models.forEach(function(e){return i.append('<option value="'+e.id+'">'+e.get("title")+"</option>")}),(r=(u=this.ctxMenu)!=null?u.parentId:void 0)?i.val(r):i.find("option[value='"+n+"']").length>0?i.val(n):i.val("route"),this.$(".parentName").val("").hide()},n.prototype.onChangeSelectParent=function(e){return e.currentTarget.value!=="new"?this.$(".parentName").hide():this.$(".parentName").show().focus()},n.prototype.onClickSelectParent=function(e){return e.preventDefault()},n.prototype.onFocusParentName=function(e){return this.$(".selectParent").addClass("focus")},n.prototype.onBlurParentName=function(){return this.$(".selectParent").removeClass("focus")},n.prototype.onSubmitForm=function(){return!1},n.prototype.onClickSubmit=function(t){var n,r,i,s,o,u,a,f,l,c=this;if((u=this.$(".selectParent").val())==="new"&&(a=e.trim(this.$(".parentName").val()))==="")return!1;if((n=e.trim(this.$(".caption").val()))==="")return!1;if(/delete/.test(t!=null?t.currentTarget.className:void 0)){if(!confirm("Are you sure you want to delete this Context Menu?"))return!1;this.model.unset("ctxMenu")}else{i=this.$("input[name='ctxType']:checked").attr("value");if(u==="route")this.model.set("ctxMenu",{caption:n,contexts:i,parentId:u,order:(f=this.ctxMenu)!=null?f.order:void 0});else{if(u==="new"){if(o=this.collection.findWhere({contexts:i,title:a}))u=o.id}else a=this.$(".selectParent option[value='"+u+"']").text();this.collection.findWhere({id:u,contexts:i})||this.collection.add({id:u=H("T"),contexts:i,title:a}),this.model.set("ctxMenu",{caption:n,parentId:u,order:(l=this.ctxMenu)!=null?l.order:void 0})}}return this.trigger("getCtxMenues",r={}),_.difference(this.collection.pluck("id"),_.pluck(r.ctxMenus,"parentId")).forEach(function(e){return c.collection.remove(c.collection.get(e))}),(s=e.Deferred()).promise(),this.trigger("remakeCtxMenu",{dfd:s}),s.done(function(){return c.hidePopup()}),!1},n.prototype.tmplParentMenu='<option value="route">None(Root)</option>\n<option value="new">Create under new parent menu...</option>',n}(c),o=Backbone.Model.extend({}),u=Backbone.Collection.extend({model:o}),a=function(e){function t(e){t.__super__.constructor.call(this,e),this.$el.css({top:0,right:"30px"}).draggable({cursor:"move",delay:200,cancel:"input,textarea,button,select,option"})}return it(t,e),t.prototype.el=".ctxMenusGetter",t.prototype.events=_.extend({"click .add":"onClickAdd","click .cancel":"onClickCancel"},y.prototype.events),t.prototype.render=function(e){return this.$(".message").html(this.tmplMessage(e)),this.$el.show(200),this},t.prototype.hidePopup=function(){return this.$el.hide(200)},t.prototype.onClickAdd=function(){return this.$el.hide(200),this.trigger("addCtxMenus")},t.prototype.onClickCancel=function(){return this.$el.hide(200),this.trigger("addCtxMenus",!0)},t.prototype.tmplMessage=_.template('Add entries to the context menu for <span class="ctxmenu-icon"><i class="<%=icon%>"></i></span><strong><%=contextName%></strong><%=folder%><br>from the functions that you selected.'),t}(y),f=function(t){function n(e){var t,r,i;n.__super__.constructor.call(this,e),this.ctxMenuGetterView=new a({}),this.ctxMenuGetterView.on("addCtxMenus",this.onAddCtxMenus,this),L.on("showPopup",this.onShowPopup,this),B.on("showPopup",this.onShowPopup,this),F.on("addCtxMenu",this.onAddCtxMenu,this),t=document.getCSSCanvasContext("2d","empty",18,18),t.strokeStyle="#CC0000",t.lineWidth="2",t.lineCap="round",t.beginPath(),t.moveTo(1,1),t.lineTo(17,17),t.moveTo(1,17),t.lineTo(17,1),t.stroke(),t=document.getCSSCanvasContext("2d","updown",26,24),t.fillStyle="rgb(122, 122, 160)",t.lineWidth="2",t.lineCap="round",t.lineJoin="round",t.strokeStyle="#333333";for(r=i=0;i<=1;r=++i)t.beginPath(),t.moveTo(1,5),t.lineTo(5,1),t.lineTo(9,5),t.moveTo(5,1),t.lineTo(5,9),t.stroke(),t.translate(18,18),t.rotate(180*Math.PI/180);this.collection.comparator=function(e){return e.get("order")}}return it(n,t),n.prototype.name="ctxMenuManager",n.prototype.el=".ctxMenuManager",n.prototype.events=_.extend({"mousedown span[tabindex='0']":"onClickItem","mousedown button,input,a":"onClickClickable","mousedown .newmenu":"onClickNew","mousedown .newfolder":"onClickNewFolder","mousedown .rename":"onClickRen","dblclick  .menuCaption,.title":"onClickRen","keydown   .menuCaption,.title":"onKeydownCaption","mousedown .remove":"onClickRemove","submit .editCaption":"doneEditCaption","blur .editCaption input":"cancelEditCaption",mousedown:"onClickBlank","click .done":"onClickDone"},h.prototype.events),n.prototype.render=function(){var t,n=this;return t=window.innerHeight-60,this.$(".result_outer").height(t-35),this.$el.height(t),this.setContextMenu(),this.setSortable(".folders",".title,.menuCaption",this.onUpdateFolder),this.setSortable(".ctxMenus",".menuCaption",this.onUpdateMenu),e.each(this.$(".editButtons button"),function(e,t){return n.disableButton(_.map(document.querySelectorAll(".editButtons button"),function(e){return e.className.match(/^(\w+)\s/)[1]}))}),this.$el.append(this.tmplHelp(this)),this},n.prototype.onShowPopup=function(e,t,r){return n.__super__.onShowPopup.call(this,e,t,r)?K():!1},n.prototype.hidePopup=function(){return M(),n.__super__.hidePopup.call(this)},n.prototype.onSubmitForm=function(){return!1},n.prototype.setSortable=function(e,t,n){var r=this;return this.$(e).sortable({scroll:!0,handle:t,connectWith:e,placeholder:"ui-placeholder",delay:200,update:function(e,t){return n(e,t,r)},start:function(e,t){return r.onStartSort(e,t)},stop:function(e,t){return r.onStopSort(e,t,r)}})},n.prototype.setFolderDroppable=function(t){var n;return n=this,t.droppable({accept:".ctxMenuItem.route",tolerance:"pointer",hoverClass:"drop-folder-hover",over:function(){return e(".folders .ui-placeholder").hide()},out:function(){return e(".folders .ui-placeholder").show()},drop:function(t,r){var i;return i=e(this).find(".ctxMenus"),r.draggable.hide("fast",function(){return n.onUpdateMenu(null,{item:e(this).appendTo(i).removeClass("route").show().find("span[tabindex='0']").focus()},n)})}})},n.prototype.onUpdateFolder=function(t,n,r){var i,s;if(n&&_.filter(n.item.parent().find(".title"),function(e){var t;return e.textContent===((t=n.item.prevInfo)!=null?t.text:void 0)}).length>1){alert("A folder with the name '"+n.item.prevInfo.text+"' already exists."),i=r.$(".folders."+n.item.prevInfo.contexts),s=i.children().eq(n.item.prevInfo.order).get(0)||null,i[0].insertBefore(n.item[0],s);return}e.each(r.$(".folders"),function(t,n){return(i=e(n)).find(".folder,.ctxMenuItem").length>0?i.parents(".contexts").addClass("hasFolder"):i.parents(".contexts").removeClass("hasFolder")});if(n)return n.item.focus()},n.prototype.onUpdateMenu=function(t,n,r){e.each(r.$(".ctxMenus"),function(t,n){var r;if((r=e(n)).find(".ctxMenuItem,.dummy").length===0)return r.parents(".folder").removeClass("hasFolder")});if(n)return n.item.parents(".folder").addClass("hasFolder"),n.item.focus()},n.prototype.onGetCtxMenuContexts=function(e){return e.contexts=this.collection.get(e.parentId).get("contexts")},n.prototype.onClickDone=function(){var t,n,r=this;return n=[],this.collection.reset(),e.each(this.$(".ctxMenuItem"),function(t,i){var s,o,u,a;return o=e(i),u={id:i.id},u.caption=o.find(".menuCaption").text(),u.order=t+1,u.parentId=((a=o.parents(".folder").get(0))!=null?a.id:void 0)||"route",s=o.parents(".folders")[0].className.match(/folders\s(\w+)/)[1],u.parentId==="route"?u.contexts=s:r.collection.findWhere({id:u.parentId,contexts:s})||r.collection.add({id:u.parentId,contexts:s,title:r.$("#"+u.parentId+" .title").text()}),n.push(u)}),this.trigger("setCtxMenus",n),(t=e.Deferred()).promise(),this.trigger("remakeCtxMenu",{dfd:t}),t.done(function(){return r.hidePopup()}),!1},n.prototype.onClickBlank=function(){},n.prototype.onClickClickable=function(e){return e.stopPropagation()},n.prototype.onClickNew=function(t){var n,r,i,s,o;if(!/contexts|title/.test((o=(s=e(document.activeElement)).get(0))!=null?o.className:void 0))return;return this.activeFolder={},s.hasClass("contexts")?(this.activeFolder.folder="",r=s,this.activeFolder.parentId="route",this.activeFolder.contexts=(n=s.parent()[0].className).match(/droppable\s(\w+)/)[1],this.activeFolder.selector="."+n.replace(/\s/g,".")+" .contexts"):(this.activeFolder.folder=" in the folder '<strong>"+s.text()+"</strong>'",r=s.parents("div.contexts").find("span.contexts"),this.activeFolder.parentId=s.parent()[0].id,this.activeFolder.selector="#"+this.activeFolder.parentId+" .title"),this.activeFolder.icon=r.find("i")[0].className,this.activeFolder.contextName=r.text(),this.ctxMenuGetterView.render(this.activeFolder),i=_.map(this.$(".ctxMenuItem"),function(e){return e.id}),this.trigger("enterCtxMenuSelMode",i),this.$(".result_outer").getNiceScroll().hide(),this.$el.hide(),e(".backscreen").hide()},n.prototype.onAddCtxMenu=function(e){return this.setContextMenuItem(_.extend(e,this.activeFolder)),this.$("#"+e.id).hide().show(300),this.setSortable(".ctxMenus",".menuCaption",this.onUpdateMenu),this.$(".folders").sortable("refresh")},n.prototype.onAddCtxMenus=function(t){this.trigger("leaveCtxMenuSelMode",t),this.$el.show(),this.$(".result_outer").getNiceScroll().show(),e(".backscreen").show(),this.$(this.activeFolder.selector).focus();if(t)return;return this.trigger("triggerEventSelected"),this.onUpdateMenu(null,null,this),this.onUpdateFolder(null,null,this),this.$(this.activeFolder.selector).focus()},n.prototype.onClickNewFolder=function(t){var n,r,i;if(!(i=e(document.activeElement)).hasClass("contexts"))return;return n=i.parents(".contexts").find(".folders"),(r=e(this.tmplFolder({id:H("T"),title:""})).appendTo(n)).find(".title").focus(),this.setSortable(".ctxMenus",".menuCaption",this.onUpdateMenu),this.$(".folders").sortable("refresh"),this.setFolderDroppable(r),this.enableButton(["rename","remove","newmenu"]),this.disableButton(["newfolder"]),this.onClickRen(t)},n.prototype.onKeydownCaption=function(e){if(e.originalEvent.keyIdentifier==="F2")return this.onClickRen(e)},n.prototype.onClickRen=function(t){var n,r;if(!/title|menuCaption/.test((r=e(document.activeElement))[0].className))return;return n=r.hide().parent().find(".editCaption input:first").show(),n.val(r.text()).focus(),t.preventDefault()},n.prototype.escapeAmp=function(e){return e.replace(/&&/g,"^ampersand^").replace(/&/g,"").replace(/^ampersand^/g,"")},n.prototype.doneEditCaption=function(t){var n,r,i,s;if(!(s=e.trim((n=e(t.currentTarget).find("> input")).val())))return n.blur(),!1;if((r=n.parent().parent()).hasClass("folder")){i=!0,e.each(r.parent().find(".title"),function(t,o){if(r[0]!==o.parentNode&&o.textContent===s)return e("#tiptip_content").text("Folder '"+s+"' already exists."),n.tipTip(),i=!1});if(!i)return!1}return n.hide().parents("div:first").find("> .title,> .menuCaption").show().text(s).focus(),!1},n.prototype.cancelEditCaption=function(t){var n;if(!(n=e(t.currentTarget).hide().parents("div:first").find(".title,.menuCaption").show()).text())return n.parents(".folder").remove()},n.prototype.onClickRemove=function(t){var n;if(!/title|menuCaption/.test((n=e(document.activeElement))[0].className))return;return n.parent().remove(),this.onUpdateMenu(null,null,this),this.onUpdateFolder(null,null,this)},n.prototype.enableButton=function(e){return e.forEach(function(e){return this.$("button."+e).removeClass("disabled").removeAttr("disabled")})},n.prototype.disableButton=function(e){return e.forEach(function(e){return this.$("button."+e).addClass("disabled").attr("disabled","disabled")})},n.prototype.onClickItem=function(e){switch(e.currentTarget.className){case"contexts":this.enableButton(["newmenu","newfolder"]),this.disableButton(["rename","remove"]);break;case"title":this.enableButton(["rename","remove","newmenu"]),this.disableButton(["newfolder"]);break;case"menuCaption":this.enableButton(["rename","remove"]),this.disableButton(["newmenu","newfolder"])}return e.currentTarget.focus(),e.preventDefault(),e.stopPropagation()},n.prototype.onHoverMoveItem=function(e){},n.prototype.onHoverOffMoveItem=function(){},n.prototype.onMouseoverDroppable=function(){return this.$(".ctxMenus .ui-placeholder").hide()},n.prototype.onStartSort=function(e,t){t.item.find("span[tabindex='0']:first").focus();if(/folder/.test(t.item[0].className))return t.item.addClass("sorting").find(".ctxMenus").hide(),t.item.prevInfo={contexts:t.item.parent()[0].className.match(/folders\s(\w+)/)[1],order:t.item.parent().children().index(t.item),text:t.item.find(".title").text()}},n.prototype.onStopSort=function(e,t,n){return t.item.find("span[tabindex='0']:first").focus(),n.$(".folder").removeClass("sorting"),n.$(".ctxMenus").show()},n.prototype.onClickExpandIcon=function(t){var n,r;return this.$(t.currentTarget).parents(".folder").focus(),n=(r=e(t.currentTarget).parents(".contexts")).hasClass("expanded"),n?r.removeClass("expanded"):r.addClass("expanded"),Y(),t.stopPropagation()},n.prototype.setContextMenu=function(){var t,n,r,i,s,o=this;this.$(".result").empty(),this.trigger("getCtxMenues",t={}),r=t.ctxMenus;for(i in Q)this.elResult$.append(n=e(this.tmplContexts({contexts:i,dispname:i.substring(0,1).toUpperCase()+i.substring(1),icon:Q[i][1]}))),s=this,n.find(".droppable").droppable({accept:".ctxMenuItem:not(.route)",tolerance:"pointer",hoverClass:"drop-hover",over:function(){return e(".ctxMenus .ui-placeholder").hide()},out:function(){return e(".ctxMenus .ui-placeholder").show()},drop:function(t,n){var r;return r=e(".folders."+this.className.match(/droppable\s(\w+)/)[1]),n.draggable.hide("fast",function(){return s.onUpdateMenu(null,{item:e(this).appendTo(r).addClass("route").show().find("span[tabindex='0']").focus()},s)})}});return r.forEach(function(e){return o.setContextMenuItem(e)}),this.onUpdateMenu(null,null,this),this.onUpdateFolder(null,null,this)},n.prototype.setContextMenuItem=function(e){var t,n;return e.parentId==="route"?(t=this.$(".contexts .folders."+e.contexts),e.route=" route"):(e.route="",(t=this.$("#"+e.parentId+" .ctxMenus")).length>0||(n=this.collection.get(e.parentId),this.$(".contexts .folders."+n.get("contexts")).append(this.tmplFolder({id:n.id,title:n.get("title")})),t=this.$("#"+e.parentId+" .ctxMenus"),this.setFolderDroppable(this.$("#"+e.parentId)))),t.append(this.tmplMenuItem(e))},n.prototype.tmplContexts=_.template('<div class="contexts">\n  <div class="droppable <%=contexts%>">\n    <span class="contexts" tabindex="0"><i class="<%=icon%> contextIcon"></i><%=dispname%></span>\n  </div>\n  <div class="folders <%=contexts%>"></div>\n</div>'),n.prototype.tmplFolder=_.template('<div class="folder hasFolder" id="<%=id%>">\n  <span class="title" tabindex="0"><%=title%></span>\n  <div class="updown"></div>\n  <div class="emptyFolder"></div>\n  <form class="editCaption"><input type="text"></form>\n  <div class="ctxMenus"></div>\n</div>'),n.prototype.tmplMenuItem=_.template('<div class="ctxMenuItem<%=route%>" id="<%=id%>">\n  <span class="menuCaption" tabindex="0" title="<%=shortcut%>"><%=caption%></span>\n  <div class="updown"></div>\n  <form class="editCaption"><input type="text"></form>\n</div>'),n}(h),P=100,O=100,q=null,j={},$=null,J=null,I=null,R=!0,b={google:{families:["Noto+Sans::latin"]}},z={remap:["Remap","icon-random"],command:["Command...","icon-cog"],bookmark:["Bookmark...","icon-bookmark"],disabled:["Disabled","icon-ban-circle"],sleep:["Sleep","icon-eye-close"],comment:["Comment","icon-comment-alt"],through:["Pause","icon-pause","nodisp"]},E={current:"Open in current tab",newtab:"Open in new tab",newwin:"Open in new window",incognito:"Open in incognito window"},D=function(e){var t;return t={"&":"&amp;","<":"&lt;",">":"&gt;"},e.replace(/[&<>]/g,function(e){return t[e]})},X=["Ctrl","Alt","Shift","Win","MouseL","MouseR","MouseM"],W=["c","a","s","w"],A=function(e){var t,n,r,i;if(!e)return null;r=parseInt(e.substring(0,2),16),i=e.substring(2);if(n=I[i])return t=[],r&1&&t.push(X[0]),r&4&&t.push(X[2]),r&2&&t.push(X[1]),r&8&&t.push(X[3]),r&16&&t.push(X[4]),r&32&&t.push(X[5]),r&64&&t.push(X[6]),r&4?t.push(n[1]||n[0]):t.push(n[0]),t.join(" + ")},G=function(e){var t,n,r,i,s,o,u;i=parseInt(e.substring(0,2),16),n=[];for(t=o=0,u=W.length;0<=u?o<u:o>u;t=0<=u?++o:--o)i&Math.pow(2,t)&&n.push(W[t]);return s=e.substring(2),r=I[s],"["+n.join("")+"]"+r[0]},p=Backbone.View.extend({scHelpUrl:"https://support.google.com/chrome/answer/157179?hl=",el:"div.header",events:{"click button.addKeyConfig":"onClickAddKeyConfig","click .ctxmgr":"onClickCtxmgr","change select.kbdtype":"onChangeSelKbd"},initialize:function(t){var n,r,i=this;return I=j[n=this.model.get("kbdtype")].keys,r=this.$("select.kbdtype"),e.each(j,function(e,t){return r.append('<option value="'+e+'">'+t.name+"</option>")}),r.val(n),this.setScHelp(n)},onClickAddKeyConfig:function(e){return this.trigger("clickAddKeyConfig",e)},onClickCtxmgr:function(){return this.trigger("showPopup","ctxMenuManager")},onChangeSelKbd:function(e){return this.trigger("changeSelKbd",e),this.setScHelp(this.$("select.kbdtype").val())},setScHelp0:function(e){return this.$(".scHelp").text("ショートカットキー一覧").attr("href",this.scHelpUrl+"ja")},setScHelp:function(e){return e==="JP"?this.$(".scHelp").text("Keyboard shortcuts").attr("href",this.scHelpUrl+"ja"):this.$(".scHelp").text("Keyboard shortcuts").attr("href",this.scHelpUrl+"en")},onEnterCtxMenuSelMode:function(){return this.$("button").attr("disabled","disabled").addClass("disabled")},onLeaveCtxMenuSelMode:function(){return this.$("button").removeAttr("disabled").removeClass("disabled")}}),s=Backbone.Model.extend({}),d=Backbone.Model.extend({idAttribute:"new",defaults:{mode:"remap"}}),v=Backbone.Collection.extend({model:d}),g=Backbone.View.extend({kbdtype:null,optionKeys:[],events:{"click .origin,.new":"onClickInput","click div.mode":"onClickMode","click .selectMode div":"onChangeMode","click .edit":"onClickEdit","click .addCommand":"onClickAddCommand","click .copySC":"onClickCopySC","click div.ctxmenu":"onClickCtxMenu","click .pause":"onClickPause","click .resume":"onClickResume","click .delete":"onClickDelete","click .editSleep":"onClickEditSleep","click input.memo,.inputSleep":"onClickInputMemo","click button.cog":"onClickCog","click .updown a":"onClickUpDownChild","focus .new,.origin":"onFocusKeyInput","focus .inputSleep":"onClickInputMemo","keydown .origin":"onKeydownOrigin","keydown .new":"onKeydownNew","submit  .memo":"onSubmitMemo","submit  .formSleep":"onSubmitSleep","blur  .selectMode":"onBlurSelectMode","blur  .selectCog":"onBlurSelectCog","blur  input.memo":"onBlurInputMemo","blur  .inputSleep":"onBlurInputSleep",mouseover:"onMouseOverChild",mouseout:"onMouseOutChild"},initialize:function(e){return this.optionKeys=_.keys(z),this.model.on({"change:bookmark":this.onChangeBookmark,"change:command":this.onChangeCommand,"change:ctxMenu":this.onChangeCtxmenu,setFocus:this.onClickInput,remove:this.onRemove,setUnselectable:this.onSetUnselectable,setRowspan:this.onSetRowspan,updatePosition:this.onUpdatePosition,showPopup:this.onShowPopup,triggerEventCtxMenuSelected:this.onTriggerCtxMenuSelected},this),this.model.collection.on({kbdEvent:this.onKbdEvent,changeKbd:this.onChangeKbd,updateOrderByEl:this.onUpdateOrderByEl,mouseoverchild:this.onMouseOverChild,mouseoutchild:this.onMouseOutChild},this)},render:function(e){var t;return this.setElement(this.template({options:z})),t=this.model.get("mode"),/^C/.test(this.model.id)?this.$el.addClass("child").find("th:first-child").remove().end().find(".disabled").hide():this.setKbdValue(this.$(".new"),this.model.id)?(this.$el.find(".sleep").hide(),this.onSetRowspan()):this.state="invalid",!this.$el.hasClass("parent"
)&&!this.$el.hasClass("child")&&this.$el.find(".comment").hide(),this.setKbdValue(this.$(".origin"),this.model.get("origin")),this.kbdtype=e,this.onChangeMode(null,t),this},onChangeBookmark:function(){return this.onChangeMode(null,"bookmark")},onChangeCommand:function(){return this.onChangeMode(null,"command")},onChangeCtxmenu:function(){var e,t;return(t=this.model.get("ctxMenu"))&&!this.$el.hasClass("child")?(t.parentId!=="route"&&(this.model.collection.trigger("getCtxMenuContexts",e={parentId:t.parentId}),t.contexts=e.contexts),this.$("td.ctxmenu").html('<div class="ctxmenu-icon" title="Context menu for '+t.contexts+"\n Title: "+t.caption+'"><i class="'+Q[t.contexts][1]+'"></i></div>'),this.$("div.ctxmenu")[0].childNodes[1].nodeValue=" Edit context menu..."):this.model.get("mode")!=="disabled"&&!this.$el.hasClass("child")&&(this.$("td.ctxmenu").empty(),this.$("div.ctxmenu")[0].childNodes[1].nodeValue=" Create context menu..."),this.trigger("resizeInput")},onRemove:function(){var e;return(e=this.model.get("parentId"))&&this.model.collection.trigger("mouseoutchild",e),this.model.collection.off(null,null,this),this.model.off(null,null,this),this.off(null,null,null),this.remove()},onSetUnselectable:function(e){return e?this.$el.addClass("unselectable"):this.$el.removeClass("unselectable")},onTriggerCtxMenuSelected:function(){var e;if(this.$el.hasClass("unselectable"))return this.$el.removeClass("ui-selected unselectable");if(this.$el.hasClass("ui-selected"))return this.$el.removeClass("ui-selected"),e=A(this.model.id),this.trigger("addCtxMenu",{id:this.model.id,caption:this.getDescription()||e,shortcut:e})},onSetRowspan:function(){var e;if((e=this.model.collection.where({parentId:this.model.id})).length>0)return this.$el.addClass("parent").find(".selectMode .comment").show(),this.$("th:first-child").attr("rowspan",e.length+1),this.model.set("batch",!0);this.$el.removeClass("parent"),this.$("th:first-child").removeAttr("rowspan"),this.model.unset("batch");if(!this.$el.hasClass("child"))return this.$(".selectMode .comment").hide(),this.$("ul.updown").remove()},onShowPopup:function(e){return e?this.$el.addClass("ui-selected"):this.$el.removeClass("ui-selected")},onKbdEvent:function(t){var n,r;n=this.$("div:focus");if(n.length>0){if(n.hasClass("new")){if(this.model.id!==t&&this.model.collection.findWhere({"new":t})){e("#tiptip_content").text('"'+A(t)+'" already exists.'),n.tipTip();return}this.model.collection.where({parentId:this.model.id}).forEach(function(e){return e.set("parentId",t)})}else{r=~~t.substring(2);if(r>=512||r===349)return}this.setKbdValue(n,t),this.model.set(n[0].className.match(/(new|origin)/)[0],t),this.setDesc(),this.trigger("resizeInput");if(n.hasClass("new")&&this.model.has("ctxMenu"))return this.trigger("remakeCtxMenu",{dfd:e.Deferred()})}},onChangeKbd:function(e){return this.kbdtype=e,this.setKbdValue(this.$(".new"),this.model.id),this.setKbdValue(this.$(".origin"),this.model.get("origin")),this.setDesc()},onUpdateOrderByEl:function(){return this.model.set("order",this.$el.parent().children().index(this.$el))},onUpdatePosition:function(){return this.$el.parent()[0].insertBefore(this.el,this.$el.parent().children().eq(this.model.get("order")).get(0)||null)},onKeydownOrigin:function(e){var t,n,r,i,s,o,u;if(r=keyIdentifiers[this.kbdtype][e.originalEvent.keyIdentifier]){if(e.originalEvent.shiftKey){if(!(n=r[1]))return;i="04"}else n=r[0],i="00";for(t=o=0,u=I.length;0<=u?o<u:o>u;t=0<=u?++o:--o)if(I[t]&&(n===I[t][0]||n===I[t][1])){s=t;break}if(s)return i+=t,e.originalEvent.shiftKey?this.$(".origin").html("<span>Shift</span>+<span>"+n+"</span>"):this.$(".origin").html("<span>"+n+"</span>"),this.model.set("origin",i),this.setDesc(),this.trigger("resizeInput")}},onClickCopySC:function(e){var t,n,r,i,s,o,u,a,f;return(u=this.model.get("mode"))==="through"&&(u=this.model.get("lastMode")),(n=this.model.collection.where({parentId:this.model.id})).length>0&&(u="batch"),u==="remap"?(o="keydown",a=this.model.get("origin"),i=this.$(".desc").find(".content,.memo").text()):(o="send",a=this.model.id,i=this.$(".desc").find(".content,.command,.commandCaption,.bookmark,.memo").text()),r=this.$("td.options .mode").text().replace("Remap",""),r&&(r=" "+r+":"),s=A(a).replace(/\s/g,""),i&&(i=" "+i),t="scd."+o+"('"+G(a)+"');",f=t+" /* "+s+r+i+" */",chrome.runtime.sendMessage({action:"setClipboard",value1:f},function(e){})},getDescription:function(){var t;return this.model.get("mode")==="remap"?t=this.$(".desc").find(".content,.memo").text():t=this.$(".desc").find(".content,.command,.commandCaption,.bookmark,.memo").text(),e.trim(t)},onClickCtxMenu:function(){return this.trigger("showPopup","ctxMenuOptions",this.model,{desc:this.getDescription()})},onClickInputMemo:function(e){return e.stopPropagation()},onSubmitMemo:function(){return this.$("form.memo").hide(),this.model.set({memo:this.$("div.memo").show().html(D(this.$("input.memo").val())).text()}),M(),!1},onClickMode:function(e){if(e.currentTarget.getAttribute("title")==="Pause")return;return this.$(".selectMode").toggle().is(":visible")?(this.$(".selectMode").focus(),this.$(".mode").addClass("selecting")):this.$(".mode").removeClass("selecting"),e.stopPropagation()},onChangeMode:function(e,t){if(e){this.$(".mode").removeClass("selecting"),t=e.currentTarget.className,this.$(".selectMode").hide();if(t==="bookmark"||t==="command"){this.trigger("showPopup",t,this.model,this.model.get(t));return}}return this.model.set("mode",t),this.setDispMode(t),this.setDesc(),this.trigger("resizeInput")},onBlurSelectMode:function(){return this.$(".selectMode").hide(),this.$(".mode").removeClass("selecting")},onFocusKeyInput:function(){return q=this.el},onClickInput:function(t,n){return t?e(t.currentTarget).focus():n?this.$(n).focus():this.$(".origin").focus(),t!=null?t.stopPropagation():void 0},onBlurInputMemo:function(){return this.onSubmitMemo()},onClickCog:function(t){return this.$(".selectCog").toggle().is(":visible")?(this.$(".selectCog").focus(),e(t.currentTarget).addClass("selecting")):e(t.currentTarget).removeClass("selecting"),t.stopPropagation()},onBlurSelectCog:function(){return this.$(".selectCog").hide(),this.$("button.cog").removeClass("selecting")},onClickEdit:function(e){var t,n,r,i;(i=this.model.get("mode"))==="through"&&(i=this.model.get("lastMode"));switch(i){case"bookmark":return this.trigger("showPopup","bookmarkOptions",this.model,this.model.get("bookmark"));case"command":return this.trigger("showPopup","commandOptions",this.model,this.model.get("command"));default:return(r=this.$("div.memo")).toggle(),t=(n=this.$("form.memo").toggle().find("input.memo")).is(":visible"),t?(n.focus().val(r.text()),K()):this.onSubmitMemo(),e.stopPropagation()}},onClickAddCommand:function(){var e;/^C/.test(e=this.model.get("new"))&&(e=this.model.get("parentId")),q=this.el,this.model.collection.add({"new":H("C"),origin:~~e.substring(2)>=512?"0130":e,parentId:e});if(this.$el.hasClass("parent")){this.setDispMode(this.model.get("mode"));if(!(this.$("ul.updown").length>0))return this.$(".desc").append(this.tmplUpDown)}},onMouseOverChild:function(e,t){var n;t===this.model.id&&this.$el.addClass("hover");if(e&&(n=this.model.get("parentId")))return this.model.collection.trigger("mouseoverchild",null,n)},onMouseOutChild:function(e,t){var n;t===this.model.id&&this.$el.removeClass("hover");if(e&&(n=this.model.get("parentId")))return this.model.collection.trigger("mouseoutchild",null,n)},onClickPause:function(){var e;this.model.set("lastMode",this.model.get("mode")),this.onChangeMode(null,"through");if(e=this.model.get("ctxMenu"))return w.updateCtxMenu(this.model.id,e,!0)},onClickResume:function(){var e;this.onChangeMode(null,this.model.get("lastMode"));if(e=this.model.get("ctxMenu"))return w.updateCtxMenu(this.model.id,e,!1)},onClickDelete:function(){var e,t,n,r,i,s,o=this;if(i=this.model.get("parentId")){s="",n="'"+this.getDescription()+"'";switch(this.model.get("mode")){case"remap":s=A(this.model.get("origin"))+"\n\n ";break;case"sleep":s="Sleep "+this.model.get("sleep")+" msec",n=""}e=[],r="Are you sure you want to delete this child command?\n\n "+s+n}else(e=this.model.collection.where({parentId:this.model.id})).length>0?r="Are you sure you want to delete this shortcut and all the child commands?":r="Are you sure you want to delete this shortcut?",s=A(this.model.id),r+="\n\n "+s+"\n\n '"+this.getDescription()+"'";if(!confirm(r))return this.$(".selectCog").blur();e.forEach(function(e){return o.trigger("removeConfig",e)}),t=this.model.collection,this.trigger("removeConfig",this.model);if(i)return t.get(i).trigger("setRowspan")},onClickUpDownChild:function(t){var n,r,i,s,o,u,a,f,l=this;n=function(){var e;return e=r.id,r.set("new","temp"),r.unset("parentId"),f.set("new",e),f.set("parentId",a),r.set("new",a),o.removeClass("child").find(".disabled").show().end().prepend(s.find("th:first-child")).find("td.ctxmenu").append(s.find("div.ctxmenu-icon")).end().find(".desc").find(".ctxmenu,.copySC").show(),s.removeClass("parent hover").addClass("child").find(".disabled").hide().end().find(".desc").find(".ctxmenu,.copySC").hide()},u=-1,a=this.model.get("parentId")||this.model.id,i=[f=this.model.collection.get(a)].concat(this.model.collection.where({parentId:a})),e.each(i,function(e,t){if(t.id===l.model.id)return u=e,!1});if(t.currentTarget.title==="up"&&u>0)return(s=this.$el.prev()).before(o=this.$el),u===1&&(r=this.model,n()),this.trigger("updateChildPos");if(t.currentTarget.title==="down"&&i.length>u+1)return(s=this.$el).before(o=this.$el.next()),u===0&&(r=i[1],n()),this.trigger("updateChildPos")},onClickEditSleep:function(){var e=this;return this.$(".dispSleep").hide(),this.$(".inputSleep").show().val(this.model.get("sleep")),setTimeout(function(){return e.$(".inputSleep").focus()},0)},onSubmitSleep:function(){var e;return e=this.$(".inputSleep").val(),e?(e<0&&(e=0),e>6e4&&(e=6e4)):e=100,e=Math.round(e),this.model.set({sleep:e}),this.$(".dispSleep").show().html(e).attr("title","Sleep "+e+" msec"),this.$(".inputSleep").hide(),!1},onBlurInputSleep:function(){return this.onSubmitSleep()},setDispMode:function(e){return this.$(".mode").attr("title",z[e][0].replace("...","")).find(".icon")[0].className="icon "+z[e][1],e==="through"&&(e=this.model.get("lastMode")+" through"),this.$(".new,.origin,.icon-arrow-right").removeClass(this.optionKeys.join(" ")).addClass(e),/remap/.test(e)?(this.$("th:first,th:eq(1)").removeAttr("colspan").css("padding","").find("i").show(),this.$("th:eq(1),th:eq(2),th .origin").show().find("i").show()):this.$el.hasClass("child")?(this.$("th:first").css("padding","16px 0").find("i").hide(),this.$("th .origin").hide()):this.$el.hasClass("parent")?(this.$("th:first").removeAttr("colspan"),this.$("th:eq(1),th:eq(2)").show(),this.$("th:eq(1)").css("padding","18px 0").find("i").hide(),this.$("th .origin").hide()):(this.$("th:first").attr("colspan","3"),this.$("th:eq(1),th:eq(2)").hide())},setKbdValue:function(e,t){var n;return(n=A(t))?(e.html(_.map(n.split(" + "),function(e){return"<span>"+e+"</span>"}).join("+")),!0):!1},setDesc:function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,S;(m=this.$(".desc")).empty(),o={iconName:"",command:""},(p=this.model.get("mode"))==="through"&&(d=!0,p=this.model.get("lastMode"));switch(p){case"sleep":(v=this.model.get("sleep"))||this.model.set("sleep",v=100),m.append(this.tmplSleep({sleep:v}));break;case"bookmark":e=this.model.get("bookmark"),m.append(this.tmplBookmark({openmode:E[e.openmode],url:e.url,title:e.title})),o={iconName:"icon-wrench",command:"Edit bookmark..."};break;case"command":s=(n=N[this.model.get("command").name])[1];if(n[2]){i=[],t=this.model.get("command"),h=t.content.split("\n");for(a=y=0,w=h.length;0<=w?y<w:y>w;a=0<=w?++y:--y){if(a>2){i[a-1]+=" ...";break}i.push(h[a].replace(/"/g,"'"))}m.append(this.tmplCommandCustom({ctg:n[3],desc:s,content3row:i.join("\n"),caption:t.caption})),o={iconName:"icon-wrench",command:"Edit command..."}}else m.append(this.tmplCommand({desc:s,ctg:n[0].substring(0,1).toUpperCase()+n[0].substring(1)}));break;case"remap":case"disabled":c=this.kbdtype==="JP"?"ja":"en",p==="remap"?l=this.$(".origin").text():l=this.$(".new").text(),l=l.replace(/\s/g,"").toUpperCase(),(u=$[l])||/^CTRL\+[2-7]$/.test(l)&&(u=$["CTRL+1"]);if(u&&u[c])for(a=b=0,S=u[c].length;0<=S?b<S:b>S;a=0<=S?++b:--b)g=u[c][a].match(/(^\w+)\^(.+)/),f=RegExp.$1,r=RegExp.$2,m.append(this.tmplHelp({sectDesc:J[f],sectKey:f,scHelp:r})).find(".sectInit").tooltip({position:{my:"left+10 top-60"},tooltipClass:"tooltipClass"})}return m.html()===""&&(m.append(this.tmplMemo({memo:this.model.get("memo")})),o={iconName:"icon-pencil",command:"Edit comment"}),m.append(this.tmplDesc(o)),p==="disabled"&&this.$(".addKey,.copySC,.seprater.1st,div.ctxmenu").hide(),o.iconName===""&&m.find(".edit").hide(),d?m.find(".pause").hide():m.find(".resume").hide(),this.$el.hasClass("child")&&m.find(".ctxmenu,.copySC").hide(),(this.$el.hasClass("child")||this.$el.hasClass("parent"))&&m.append(this.tmplUpDown),this.onChangeCtxmenu()},tmplDesc:_.template('<button class="cog small" title="menu"><i class="icon-caret-down"></i></button>\n<div class="selectCog" tabIndex="0">\n  <div class="edit"><i class="<%=iconName%>"></i> <%=command%></div>\n  <div class="addCommand"><i class="icon-plus"></i> Add command</div>\n  <div class="ctxmenu"><i class="icon-reorder"></i> Create context menu...</div>\n  <div class="copySC"><i class="icon-paper-clip"></i> Copy script</div>\n  <span class="seprater 1st"><hr style="margin:3px 1px" noshade></span>\n  <div class="pause"><i class="icon-pause"></i> Pause</div>\n  <div class="resume"><i class="icon-play"></i> Resume</div>\n  <span class="seprater"><hr style="margin:3px 1px" noshade></span>\n  <div class="delete"><i class="icon-trash"></i> Delete</div>\n</div>'),tmplUpDown:'    <ul class="button-bar updown">\n      <li class="first"><a href="#" title="up"><i class="icon-chevron-up"></i></a></li>\n  <li class="last"><a href="#" title="down"><i class="icon-chevron-down"></i></a></li>\n</ul>',tmplMemo:_.template('<form class="memo">\n  <input type="text" class="memo">\n</form>\n<div class="memo"><%=memo%></div>'),tmplSleep:_.template('<form class="formSleep">\n  <input type="number" class="inputSleep" min="0" max="60000" step="10" required>\n  <span class="dispSleep" title="Sleep <%=sleep%> msec"><%=sleep%></span>\n  <i class="icon-pencil editSleep" title="Edit sleep msec(0-60000)"></i>\n</form>'),tmplBookmark:_.template('<div class="bookmark" title="<<%=openmode%>>\n<%=url%>" style="background-image:-webkit-image-set(url(chrome://favicon/size/16@1x/<%=url%>) 1x);"><%=title%></div>'),tmplCommand:_.template('<div class="ctgIcon <%=ctg%>"><%=ctg%></div><div class="command"><%=desc%></div>'),tmplCommandCustom:_.template('<div class="ctgIcon <%=ctg%>" title="<%=desc%>"><%=ctg%></div><div class="commandCaption" title="<%=content3row%>"><%=caption%></div>'),tmplHelp:_.template('<div class="sectInit" title="<%=sectDesc%>"><%=sectKey%></div><div class="content"><%=scHelp%></div>'),template:_.template('<tr class="data">\n  <th>\n    <div class="new" tabIndex="0"></div>\n    <div class="grpbartop"></div>\n    <div class="grpbarbtm"></div>\n  </th>\n  <th>\n    <i class="icon-arrow-right"></i>\n  </th>\n  <th class="tdOrigin">\n    <div class="origin" tabIndex="-1"></div>\n  </th>\n  <td class="options">\n    <div class="mode"><i class="icon"></i><span></span><i class="icon-caret-down"></i></div>\n    <div class="selectMode" tabIndex="0">\n      <% _.each(options, function(option, key) { if (option[2] != "nodisp") { %>\n      <div class="<%=key%>"><i class="icon <%=option[1]%>"></i> <%=option[0]%></div>\n      <% }}); %>\n    </div>\n  <td class="ctxmenu"></td>\n  <td class="desc"></td>\n  <td class="blank">&nbsp;</td>\n</tr>')}),m=Backbone.View.extend({placeholder:"Enter new shortcut key",el:"table.keyConfigSetView",events:{"click .addnew":"onClickAddnew","blur  .addnew":"onBlurAddnew",click:"onClickBlank"},initialize:function(e){return this.collection.comparator=function(e){return e.get("order")},this.collection.on({add:this.onAddRender,kbdEvent:this.onKbdEvent},this)},render:function(t){var n=this;return this.$el.append(this.template()),this.collection.set(t),this.$("tbody").sortable({delay:300,scroll:!0,cancel:"tr.border,tr.child,input",cursor:"move",start:function(){return n.onStartSort()},stop:function(){return n.redrawTable()}}),e(".fixed-table-container-inner").niceScroll({cursorwidth:13,cursorborderradius:2,smoothscroll:!0,cursoropacitymin:.3,cursoropacitymax:.7,zindex:999998}),this.niceScroll=e(".fixed-table-container-inner").getNiceScroll(),R=!1,this.redrawTable(),this},onAddRender:function(t){var n,r,i;r=new g({model:t}),r.on("removeConfig",this.onChildRemoveConfig,this),r.on("resizeInput",this.onChildResizeInput,this),r.on("showPopup",this.onShowPopup,this),r.on("addCtxMenu",this.onAddCtxMenu,this),r.on("updateChildPos",this.redrawTable,this),r.on("remakeCtxMenu",this.onRemakeCtxMenu,this),n=this.$("tr.addnew")[0]||null,i=this.$("tbody")[0],/^C/.test(t.id)&&q&&(n=q.nextSibling||null),i.insertBefore(r.render(this.model.get("kbdtype")).el,n),i.insertBefore(e(this.tmplBorder)[0],n),r.state==="invalid"&&this.onChildRemoveConfig(t);if(n||/^C/.test(t.id)&&!R)this.$("div.addnew").blur(),this.redrawTable();if(/^C/.test(t.id)&&q)return q=null,this.collection.get(t.get("parentId")).trigger("setRowspan"),setTimeout(function(){return t.trigger("setFocus")},0)},onKbdEvent:function(t){var n,r,i;if(this.$(".addnew").length===0){if((i=this.$(".new:focus,.origin:focus")).length!==0)return;if(n=this.collection.get(t)){n.trigger("setFocus",null,".new");return}if(!this.onClickAddKeyConfig())return}if(this.collection.findWhere({"new":t})){e("#tiptip_content").text('"'+A(t)+'" already exists.'),this.$("div.addnew").tipTip();return}return this.collection.add(r=new d({"new":t,origin:~~t.substring(2)>=512?"0130":t})),this.$("tbody").sortable("enable").sortable("refresh"),Y(),this.onChildResizeInput(),r.trigger("setFocus")},onChildRemoveConfig:function(e){return this.collection.remove(e),this.redrawTable(),Y(),this.onChildResizeInput()},onChildResizeInput:function(){var e=this;return this.$(".th_inner").css("left",0),setTimeout(function(){return e.$(".th_inner").css("left","")},0)},onShowPopup:function(e,t,n){return this.trigger("showPopup",e,t,n)},onRemakeCtxMenu:function(e){return w.remakeCtxMenu(this.getSaveData()).done(function(){return e.dfd.resolve()})},onAddCtxMenu:function(e){return this.trigger("addCtxMenu",e)},onTriggerEventSelected:function(){return this.collection.models.forEach(function(e){return e.trigger("triggerEventCtxMenuSelected")}),this.redrawTable()},onSetCtxMenus:function(e){var t=this;return this.collection.models.forEach(function(e){return e.unset("ctxMenu")}),e.forEach(function(e){var n;return n=t.collection.get(e.id),n.set("ctxMenu",e)})},onGetCtxMenues:function(e){return e.ctxMenus=[],this.collection.models.forEach(function(t){var n;if(n=t.get("ctxMenu"))return e.ctxMenus.push({id:t.id,caption:n.caption,contexts:n.contexts,parentId:n.parentId,shortcut:A(t.id),order:n.order||999})}),e.ctxMenus.sort(function(e,t){return e.order-t.order})},onEnterCtxMenuSelMode:function(e){return this.$("button").attr("disabled","disabled").addClass("disabled"),this.collection.models.forEach(function(t){var n;return t.trigger("setUnselectable",(n=t.id,st.call(e,n)>=0)?!0:!1)}),this.$("tbody").sortable("disable").selectable({cancel:"tr:has(div.ctxmenu-icon)",filter:"tr"}).find("tr:has(div.mode[title='Disabled'])").addClass("unselectable").end().find("tr:has(div.ctxmenu-icon)").addClass("unselectable").end().find("div.mode,div.new,div.origin").addClass("unselectable").end(),this.onStartSort()},onLeaveCtxMenuSelMode:function(e){this.$("button").removeAttr("disabled").removeClass("disabled"),this.$("tbody").selectable("destroy").sortable("enable").find("div.unselectable").removeClass("unselectable").end();if(e)return this.$("tr").removeClass("ui-selected unselectable"),this.redrawTable()},onClickAddKeyConfig:function(t){var n;if(this.$(".addnew").length>0)return;return this.collection.length>P?(e("#tiptip_content").text("You have reached the maximum number of items. (Max "+P+" items)"),e(t.currentTarget).tipTip({defaultPosition:"left"}),!1):(n=e(this.tmplAddNew({placeholder:this.placeholder})),/child/.test(q!=null?q.className:void 0)&&(q=e(q).prevAll(".parent:first")[0]),this.$("tbody")[0].insertBefore(n[0],q),n.find(".addnew").focus()[0].scrollIntoViewIfNeeded(),this.$("tbody").sortable("disable"),Y())},onClickBlank:function(){return this.$(":focus").blur(),q=null},onClickAddnew:function(e){return e.stopPropagation()},onBlurAddnew:function(){return this.$(".addnew").remove(),this.$("tbody").sortable("enable"),Y()},onChangeSelKbd:function(e){var t;return I=j[t=e.currentTarget.value].keys,this.collection.trigger("changeKbd",t),this.model.set("kbdtype",t)},onStartSort:function(){return this.$("tr.child").hide(),this.$(".ui-sortable-placeholder").nextAll("tr.border:first,tr.border:last").remove(),this.$(".parent th:first-child").removeAttr("rowspan")},redrawTable:function(){var t=this;return this.$("tr.child").show(),this.$("tr.border").remove(),this.collection.models.forEach(function(e){return e.trigger("setRowspan")}),e("#sortarea").append(this.$("tr.data")),this.collection.trigger("updateOrderByEl"),this.collection.sort(),this.collection.models.forEach(function(e){var t;if(t=e.get("parentId"))return e.set("order",999)}),this.collection.sort(),this.collection.models.forEach(function(e){var n;if(n=e.get("parentId"))return e.set("order",t.collection.get(n).get("order"))}),this.collection.sort(),e.each(this.collection.models,function(e,t){return t.set("order",e),t.trigger("updatePosition")}),e.each(e("#sortarea tr"),function(e,n){return t.$("tbody").append(n)}),this.$("tr.last").removeClass("last"),e.each(this.$("tbody > tr"),function(n,r){var i,s;if(!/child/.test((s=r.nextSibling)!=null?s.className:void 0)){(i=e(r)).after(t.tmplBorder);if(/child/.test(r.className))return i.addClass("last")}})},getSaveData:function(){return this.collection.remove(this.collection.findWhere({"new":this.placeholder})),{config:this.model.toJSON(),ctxMenuFolderSet:k.collection.sort().toJSON(),keyConfigSet:this.collection.toJSON()}},tmplAddNew:_.template('<tr class="addnew">\n  <th colspan="3">\n    <div class="new addnew" tabIndex="0"><%=placeholder%></div>\n  </th>\n  <td></td><td></td><td></td><td class="blank"></td>\n</tr>'),tmplBorder:'<tr class="border">\n  <td colspan="6"><div class="border"></div></td>\n  <td></td>\n</tr>',template:_.template('<thead>\n  <tr>\n    <th>\n      <div class="th_inner">New <i class="icon-arrow-right"></i> Origin shortcut key</div>\n    </th>\n    <th></th>\n    <th></th>\n    <th>\n      <div class="th_inner options">Mode</div>\n    </th>\n    <th class="ctxmenu"></th>\n    <th>\n      <div class="th_inner desc">Comment</div>\n    </th>\n    <th><div class="th_inner blank">&nbsp;</div></th>\n  </tr>\n</thead>\n<tbody></tbody>')}),U=0,V=!1,Y=function(){return V&&clearTimeout(V),V=setTimeout(function(){var t;return t=window.innerHeight-document.querySelector(".header").offsetHeight-U,document.querySelector(".fixed-table-container").style.pixelHeight=t,e(".fixed-table-container-inner").getNiceScroll().resize(),e(".result_outer").getNiceScroll().resize()},200)},K=function(){return w.startEdit()},M=function(){return w.endEdit()},w=chrome.extension.getBackgroundPage().andy,e=jQuery,e(function(){var o,a,c,h;return j=w.getKeyCodes(),$=w.getScHelp(),J=w.getScHelpSect(),h=w.local,B=new p({model:new s(h.config)}),B.render(),c=new v,F=new m({model:new s(h.config),collection:c}),S=new n({}),o=new t({}),C=new i({}),T=new r({}),a=new u,L=new l({collection:a}),k=new f({collection:a}),B.on("clickAddKeyConfig",F.onClickAddKeyConfig,F),B.on("changeSelKbd",F.onChangeSelKbd,F),L.on("getCtxMenues",F.onGetCtxMenues,F),L.on("remakeCtxMenu",F.onRemakeCtxMenu,F),k.on("getCtxMenues",F.onGetCtxMenues,F),k.on("remakeCtxMenu",F.onRemakeCtxMenu,F),c.on("getCtxMenuContexts",k.onGetCtxMenuContexts,k),k.on("enterCtxMenuSelMode",F.onEnterCtxMenuSelMode,F),k.on("enterCtxMenuSelMode",B.onEnterCtxMenuSelMode,B),k.on("leaveCtxMenuSelMode",F.onLeaveCtxMenuSelMode,F),k.on("leaveCtxMenuSelMode",B.onLeaveCtxMenuSelMode,B),k.on("triggerEventSelected",F.onTriggerEventSelected,F),k.on("setCtxMenus",F.onSetCtxMenus,F),a.reset(h.ctxMenuFolderSet),F.render(h.keyConfigSet),chrome.runtime.onMessage.addListener(function(e,t,n){switch(e.action){case"kbdEvent":return F.collection.trigger("kbdEvent",e.value);case"saveConfig":return w.saveConfig(F.getSaveData())}}),e(window).on("unload",function(){return w.saveConfig(F.getSaveData())}).on("resize",function(){return Y()}).on("click",function(){return q=null}),Y()})}).call(this);